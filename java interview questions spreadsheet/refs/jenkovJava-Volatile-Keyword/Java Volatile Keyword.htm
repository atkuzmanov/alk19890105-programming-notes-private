<!DOCTYPE html>
<!-- saved from url=(0058)http://tutorials.jenkov.com/java-concurrency/volatile.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">
    <meta name="viewport" content="width=device-width, height=device-height initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

    <title>Java Volatile Keyword</title>

    <meta name="description" content="The Java volatile keyword guarantees variable visibility across threads, meaning reads and writes are visible across threads.">
    <meta name="keywords" content="java concurrency multithreading thread volatile">
    <meta name="author" content="Jakob Jenkov">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@jjenkov">
    <meta name="twitter:title" content="Java Volatile Keyword">
    <meta name="twitter:description" content="The Java volatile keyword guarantees variable visibility across threads, meaning reads and writes are visible across threads.">
    <meta name="twitter:creator" content="@jjenkov">
    <meta name="twitter:domain" content="jenkov.com">

    <meta name="twitter:image:src" content="http://tutorials.jenkov.com/images/java-concurrency/java-concurrency-teaser-500-300.png">

    <meta name="og:type" content="article">
    <meta name="og:title" content="Java Volatile Keyword">
    <meta property="og:url" content="http://tutorials.jenkov.com/java-concurrency/volatile.html">
    <meta property="og:description" content="The Java volatile keyword guarantees variable visibility across threads, meaning reads and writes are visible across threads.">

    <meta property="og:image" content="http://tutorials.jenkov.com/images/java-concurrency/java-concurrency-teaser-500-300.png">

    <link href="https://plus.google.com/108227213807945109821" rel="publisher">

    <meta name="google-site-verification" content="i_TwzdElg-by5uXLvyAjuIaCjxo0yjtW8LdRPUDEEcw">
<script charset="utf-8" src="./Java Volatile Keyword_files/button.550007e6cc79c00bac51111d8131d860.js"></script></head>

<body>

<style>
body {background-color: #f0f0f0; xbackground-image: linear-gradient(180deg, #f0f0f0, #e0e0e0); margin: 0px; font-family: arial;}

.grid {
  display: grid;

}
.topBar, .footer {
  grid-column-start: 1;
  grid-column-end: 12;
  background-color: #000000;
  color: #ffffff;
  height: 64px;
  box-shadow: 0px 8px 6px -6px #999999;
}

.content {
  grid-column-start: 1;
  grid-column-end: 12;
  text-align: center;
}
.category, .main, .right {
	display: inline-block;
    vertical-align: top;
	box-sizing: border-box;
	text-align: left;
}
.footer {
  height: 64px;
  position: relative;
  padding-bottom: 48px;
}
#footerCopyright {
	position: absolute;
	top: 20px;
	left:20px;
}

.card{ background-color: #ffffff; box-shadow: 0px 8px 6px -6px #999999;padding: 20px 30px;border: 1px solid #e0e0e0; margin: 8px 4px;}
.cardLeft  { margin-left:   8px; }
.cardRight { margin-right:  8px; }
.cardTop   { margin-top:    8px; }
.cardBottom{ margin-bottom: 8px; }

#topBarMenu    { position: absolute; top: 20px; left: 20px; }
#topBarMenu a  { color: #ffffff; text-decoration: none; }
#topBarLogoBox { text-align: right; padding-top:6px; margin-right: 16px;}
#topBarLogo    { height: 38px; }
#topBarPhrase  { padding-right: 4px; font-size: 0.8em; }
</style>

<style>
a{ text-decoration:none; }
#main, #mainBody { text-align: left; }

#mainBody h1{margin-top: 0px; text-align:left; }
#mainBody h2{margin: 24px 0px 0px 0px; text-align:left; }
#mainBody a{font-weight: bold; color: #339;}
#mainBody img{max-width:100%;}
#mainBody svg{max-width:100%;overflow: auto;}

.card{ background-color: #ffffff; box-shadow: 0px 8px 6px -6px #999999;padding: 20px 30px;border: 1px solid #e0e0e0;}
#trailToc ol li{border-bottom: 1px solid #f0f0f0;padding: 4px 20px;vertical-align: top;}
.codeBox {background-color: #f0f0f0;border: 1px solid #cccccc;padding: 10px;max-width: 100%;overflow: auto;}
code{font-size: 1.2em;}
.dataTable{background-color: #f0f0f0;border: 1px solid #cccccc;max-width: 100%;overflow: auto;}
.dataTable th{text-align: left;}
.dataTable th, .dataTable td{padding: 2px 8px; }
#pageToc{border: 1px solid #f0f0f0; text-align:left; }
#pageToc li{margin: 6px 0px;}
#pageToc a{color: #339;font-weight: normal;}
#lastUpdate{border: 1px solid #f0f0f0;border-top:none;padding: 6px 24px;font-size: 0.8em;color: #666; text-align:left; }
#next{border-top: 1px solid #f0f0f0;padding: 10px 0px;font-size: 1.1em;}
#bottomSocial{border-top: 1px solid #f0f0f0;padding: 10px 0px;font-size: 0.9em;}
</style>


<style>
@media only screen and (max-width: 799px) {
	.main     { width: 100%;}
	.category { display: none; }
	.right    {	display: none; }
	.card     { padding: 10px 8px; }
}
@media only screen and (min-width: 800px) and (max-width: 1199px) {
	.main     { width: 75%; }
	.category {	width: 25%;	}
	.right    { display:none;}
}
@media only screen and (min-width: 1200px) {
	.main     { width: 50%;	max-width: 900px; }
	.category { width: 25%;	max-width: 300px; }
	.right    { width: 25%; max-width: 400px; display:none;}
}

@media only screen and (max-width: 600px) {
  #topBarLogo{transform: scale(0.75, 0.75) translate(0px, 0px);}
}
@media only screen and (max-width: 480px) {
  #topBarLogo{transform: scale(0.6, 0.6) translate(136px, 0px);}
  #topBarMenu a{ font-size: 0.8em; }
  h1{ font-size: 1.6em; }
  h2{ font-size: 1.4em; }
  h3{ font-size: 1.2em; }
}
</style>

<div class="grid">

    <div class="topBar">

        <div id="topBarMenu">
            <a href="http://tutorials.jenkov.com/" title="Tutorials">Tutorials</a>
            &nbsp;&nbsp;&nbsp;
            <a href="http://jenkov.com/about/index.html" title="Tutorials">About</a>
            &nbsp;&nbsp;&nbsp;
            <a href="http://jenkov.com/rss.xml" title="RSS">RSS</a>
        </div>

        <div id="topBarLogoBox">
            <div id="topBarLogo"><svg x="0px" y="0px" width="409px" height="48px" viewBox="0 0 409 100" style="enable-background:new 0 0 409 100;" xml:space="preserve">  <path d="M53,32 l10,0  l0,26  c-7,21 -30,21 -53,10  l4,-9  c18,11 33,10 39,-3  z " style="stroke: none; stroke-width: 1; fill: #ffffff;"></path>  <path d="M69,32 l50,0  l0,9  l-50,0 z" style="stroke: none; stroke-width: 1; fill: #ffffff;"></path>  <path d="M69,49 l50,0  l0,9  l-50,0 z" style="stroke: none; stroke-width: 1; fill: #ffffff;"></path>  <path d="M69,65 l50,0  l0,9  l-50,0 z" style="stroke: none; stroke-width: 1; fill: #ffffff;"></path>  <path d="M126,32 l13,0  l40,31  l0,-31  l10,0  l0,42  l-10,0 l-43,-32 l0,32 l-10,0 z " style="stroke: none; stroke-width: 1; fill: #ffffff;"></path>  <path d="M179,32  l10,0  l0,15 l5,0  l32.5,-14.5  l19,0  l-41,19  l40,22  l-19,0  l-33,-18  l-3.5,0  l0,19  l-10,0 z " style="stroke: none; stroke-width: 1; fill: #ffffff;"></path>  <path d="M238,49  c10,-24 60,-24 70,0  l-11,0  c-10,-12 -38,-12 -48,0  z " style="stroke: none; stroke-width: 1; fill: #ffffff;"></path>  <path d="M238,57  c10,24 60,24 70,0  l-11,0  c-10,12 -38,12 -48,0  z " style="stroke: none; stroke-width: 1; fill: #ffffff;"></path>  <path d="M304,32  l13,0  l25,34 l25,-34  l13,0  l-32,42 l-12.5,0 z" style="stroke: none; stroke-width: 1; fill: #ffffff;"></path>  <path d="M369,65  l12,0 l0,8 l-12,0 z" style="stroke: none; stroke-width: 1; fill: #ffffff;"></path>  <path d="M390,53  c3,-27 54,-27 67,-10  l-15,0  c-10,-5 -40,-5 -41.5,10 l-10,0  " style="stroke: none;  stroke-width: 1; fill: #ffffff;"></path>  <path d="M390,53  c3,27 54,27 67,10  l-15,0  c-10,5 -40,5 -41.5,-10 l-10,0  " style="stroke: none;  stroke-width: 1; fill: #ffffff;"></path>  <path d="M460,49  c10,-24 60,-24 70,0  l-11,0  c-10,-12 -38,-12 -48,0  z " style="stroke: none; stroke-width: 1; fill: #ffffff;"></path>  <path d="M460,57  c10,24 60,24 70,0  l-11,0  c-10,12 -38,12 -48,0  z " style="stroke: none; stroke-width: 1; fill: #ffffff;"></path>  <path d="M534,34  l10,0  l0,6 c13,-10 26,-10 37,0  c12,-10 32,-10 39,3  l0,30  l-10,0  l0,-27  c-3,-9 -24,-9 -28,3 l0,24  -10,0  l0,-27  c-3,-9 -24,-9 -28,3 l0,24  -10,0 z" style="stroke: none; stroke-width: 1; fill: #ffffff;"></path></svg></div>
            <div id="topBarPhrase">Tech and Media Labs</div>
        </div>

    </div>


    <div class="content">
        <div class="site-menu">

            <!--
              <div class="card cardLeft cardTop">Software Development
                <ul>
                  <li>Java &amp; JVM</li>
                  <li>Web</li>
                  <li>Distributed Systems</li>
                </ul>
            </div>
            -->
        </div><div class="category">
        <div id="trailToc" class="card cardTop cardBottom">
            <div id="trailTitle">Java Concurrency</div><ol><li><a href="http://tutorials.jenkov.com/java-concurrency/index.html">Java Concurrency and Multithreading Tutorial</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/benefits.html">Multithreading Benefits</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/costs.html">Multithreading Costs</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/concurrency-models.html">Concurrency Models</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/same-threading.html">Same-threading</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/concurrency-vs-parallelism.html">Concurrency vs. Parallelism</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/creating-and-starting-threads.html">Creating and Starting Java Threads</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/race-conditions-and-critical-sections.html">Race Conditions and Critical Sections</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/thread-safety.html">Thread Safety and Shared Resources</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/thread-safety-and-immutability.html">Thread Safety and Immutability</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/java-memory-model.html">Java Memory Model</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/synchronized.html">Java Synchronized Blocks</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/volatile.html"><b>Java Volatile Keyword</b></a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/threadlocal.html">Java ThreadLocal</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/thread-signaling.html">Thread Signaling</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/deadlock.html">Deadlock</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/deadlock-prevention.html">Deadlock Prevention</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/starvation-and-fairness.html">Starvation and Fairness</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/nested-monitor-lockout.html">Nested Monitor Lockout</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/slipped-conditions.html">Slipped Conditions</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/locks.html">Locks in Java</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/read-write-locks.html">Read / Write Locks in Java</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/reentrance-lockout.html">Reentrance Lockout</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/semaphores.html">Semaphores</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/blocking-queues.html">Blocking Queues</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/thread-pools.html">Thread Pools</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/compare-and-swap.html">Compare and Swap</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/anatomy-of-a-synchronizer.html">Anatomy of a Synchronizer</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/non-blocking-algorithms.html">Non-blocking Algorithms</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/amdahls-law.html">Amdahl's Law</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/references.html">Java Concurrency References</a></li></ol>
        </div>
    </div><div class="main">
        <div class="card cardTop cardBottom">
            <h1 style="text-align: left;">Java Volatile Keyword</h1>

            <div id="pageToc" itemscope="" itemtype="http://schema.org/SiteNavigationElement">
                <ul><li><a href="http://tutorials.jenkov.com/java-concurrency/volatile.html#variable-visibility-problems">Variable Visibility Problems</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/volatile.html#the-java-volatile-visibility-guarantee">The Java volatile Visibility Guarantee</a><ul><li><a href="http://tutorials.jenkov.com/java-concurrency/volatile.html#full-volatile-visibility-guarantee">Full volatile Visibility Guarantee</a></li></ul></li><li><a href="http://tutorials.jenkov.com/java-concurrency/volatile.html#instruction-reordering-challenges">Instruction Reordering Challenges</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/volatile.html#the-java-volatile-happens-before-guarantee">The Java volatile Happens-Before Guarantee</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/volatile.html#volatile-is-not-always-enough">volatile is Not Always Enough</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/volatile.html#when-is-volatile-enough">When is volatile Enough?</a></li><li><a href="http://tutorials.jenkov.com/java-concurrency/volatile.html#performance-considerations-of-volatile">Performance Considerations of volatile</a></li></ul>
            </div>
            <div id="lastUpdate">
                <table><tbody><tr><td class="authorPhoto"></td>
                    <td><p style="margin: 0px 0px 6px 0px;">
                        Jakob Jenkov<br>
                        Last update: 2018-03-08
                    </p>
                        <div class="authorSocialLinks"></div>
                    </td>
                </tr>
                </tbody></table>
            </div>

            <div id="mainBody">
                <p>
    The Java <code>volatile</code> keyword is used to mark a Java variable as "being stored in main memory".
    More precisely that means, that every read of a volatile variable will be read from the computer's main memory,
    and not from the CPU cache, and that every write to a volatile variable will be written to main memory, and not
    just to the CPU cache.
</p>

<p>
    Actually, since Java 5 the <code>volatile</code> keyword guarantees more than just that volatile variables are written
    to and read from main memory. I will explain that in the following sections.
</p>




<a name="variable-visibility-problems"></a>
<h2>Variable Visibility Problems</h2>

<p>
    The Java <code>volatile</code> keyword guarantees visibility of changes to variables across threads. This may
    sound a bit abstract, so let me elaborate.
</p>

<p>
    In a multithreaded application where the threads operate on non-volatile variables, each thread may copy variables
    from main memory into a CPU cache while working on them, for performance reasons. If your computer contains more
    than one CPU, each thread may run on a different CPU. That means, that each thread may copy the variables into
    the CPU cache of different CPUs. This is illustrated here:
</p>

<img src="./Java Volatile Keyword_files/java-volatile-1.png" alt="Threads may hold copies of variables from main memory in CPU caches.">


<p>
    With non-volatile variables there are no guarantees about when the Java Virtual Machine (JVM) reads data from main memory into
    CPU caches, or writes data from CPU caches to main memory. This can cause several problems which I will explain
    in the following sections.
</p>

<p>
    Imagine a situation in which two or more threads have access to a shared object which contains a counter variable
    declared like this:
</p>

<pre class="codeBox">public class SharedObject {

    public int counter = 0;

}
</pre>

<p>
    Imagine too, that only Thread 1 increments the <code>counter</code> variable, but both Thread 1 and Thread 2 may
    read the <code>counter</code> variable from time to time.
</p>

<p>
    If the <code>counter</code> variable is not declared  <code>volatile</code> there is no guarantee about when the
    value of the <code>counter</code> variable is written from the CPU cache back to main memory. This means, that
    the <code>counter</code> variable value in the CPU cache may not be the same as in main memory. This situation is
    illustrated here:
</p>

<img src="./Java Volatile Keyword_files/java-volatile-2.png" alt="The CPU cache used by Thread 1 and main memory contains different values for the counter variable.">

<p>
    The problem with threads not seeing the latest value of a variable because it has not yet been written back to main
    memory by another thread, is called a "visibility" problem. The updates of one thread are not visible to other threads.
</p>




<a name="the-java-volatile-visibility-guarantee"></a>
<h2>The Java volatile Visibility Guarantee</h2>

<p>
    The Java <code>volatile</code> keyword is intended to address variable visibility problems.
    By declaring the <code>counter</code> variable <code>volatile</code> all writes to the <code>counter</code>
    variable will be written back to main memory immediately. Also, all reads of the <code>counter</code> variable will
    be read directly from main memory.
</p>

<p>
    Here is how the <code>volatile</code> declaration of the <code>counter</code>  variable looks:
</p>


<pre class="codeBox">public class SharedObject {

    public <b>volatile</b> int counter = 0;

}
</pre>

<p>
    Declaring a variable <code>volatile</code> thus <i>guarantees the visibility</i> for other threads of writes to that
    variable.
</p>

<p>
    In the scenario given above, where one thread (T1) modifies the counter, and another thread (T2) reads the counter
    (but never modifies it), declaring the <code>counter</code> variable <code>volatile</code> is enough to guarantee
    visibility for T2 of writes to the <code>counter</code> variable.
</p>

<p>
    If, however, both T1 and T2 were incrementing the <code>counter</code> variable, then declaring the
    <code>counter</code> variable <code>volatile</code> would not have been enough. More on that later.
</p>



<a name="full-volatile-visibility-guarantee"></a>
<h3>Full volatile Visibility Guarantee</h3>

<p>
    Actually, the visibility guarantee of Java <code>volatile</code> goes beyond the <code>volatile</code>
    variable itself. The visibility guarantee is as follows:
</p>

<ul>
    <li>
        If Thread A writes to a <code>volatile</code> variable and Thread B subsequently reads the same volatile variable,
        then all variables visible to Thread A before writing the volatile variable, will also be visible to Thread B after
        it has read the volatile variable.
    </li>

    <li>
        If Thread A reads a <code>volatile</code> variable, then all all variables visible to Thread A when reading
        the <code>volatile</code> variable will also be re-read from main memory.
    </li>
</ul>

<p>
    Let me illustrate that with a code example:
</p>

<pre class="codeBox">public class MyClass {
    private int years;
    private int months
    private volatile int days;


    public void update(int years, int months, int days){
        this.years  = years;
        this.months = months;
        this.days   = days;
    }
}
</pre>


<p>
    The <code>udpate()</code> method writes three variables, of which only <code>days</code> is volatile.
</p>

<p>
    The full <code>volatile</code> visibility guarantee means, that when a value is written to <code>days</code>,
    then all variables visible to the thread are also written to main memory. That means, that when a value is
    written to <code>days</code>, the values of <code>years</code> and <code>months</code> are also written to
    main memory.
</p>

<p>
    When reading the values of <code>years</code>, <code>months</code> and <code>days</code> you could do it
    like this:
</p>

<pre class="codeBox">public class MyClass {
    private int years;
    private int months
    private volatile int days;

    <b>public int totalDays() {
        int total = this.days;
        total += months * 30;
        total += years * 365;
        return total;
    }</b>

    public void update(int years, int months, int days){
        this.years  = years;
        this.months = months;
        this.days   = days;
    }
}
</pre>

<p>
    Notice the <code>totalDays()</code> method starts by reading the value of <code>days</code> into the
    <code>total</code> variable. When reading the value of <code>days</code>, the values of <code>months</code>
    and <code>years</code> are also read into main memory. Therefore you are guaranteed to see the latest
    values of <code>days</code>, <code>months</code> and <code>years</code> with the above read sequence.
</p>



<a name="instruction-reordering-challenges"></a>
<h2>Instruction Reordering Challenges</h2>
<p>
    The Java VM and the CPU are allowed to reorder instructions in the program for performance reasons, as long
    as the semantic meaning of the instructions remain the same. For instance, look at the following instructions:
</p>

<pre class="codeBox">int a = 1;
int b = 2;

a++;
b++;
</pre>

<p>
    These instructions could be reordered to the following sequence without losing the semantic meaning of the program:
</p>

<pre class="codeBox">'
int a = 1;
a++;

int b = 2;
b++;
</pre>

<p>
    However, instruction reordering present a challenge when one of the variables is a <code>volatile</code> variable.
    Let us look at the <code>MyClass</code> class from the example earlier in this Java volatile tutorial:
</p>

<pre class="">public class MyClass {
    private int years;
    private int months
    private volatile int days;


    public void update(int years, int months, int days){
        this.years  = years;
        this.months = months;
        this.days   = days;
    }
}
</pre>


<p>
    Once the <code>update()</code> method writes a value to <code>days</code>, the newly written values to
    <code>years</code> and <code>months</code> are also written to main memory. But, what if the Java VM
    reordered the instructions, like this:
</p>

<pre class="codeBox">public void update(int years, int months, int days){
    this.days   = days;
    this.months = months;
    this.years  = years;
}
</pre>

<p>
    The values of <code>months</code> and <code>years</code> are still written to main memory
    when the <code>days</code> variable is modified, but this time it happens before the new values have been
    written to <code>months</code> and <code>years</code>. The new values are thus not properly made visible
    to other threads. The semantic meaning of the reordered instructions has changed.
</p>

<p>
    Java has a solution for this problem, as we will see in the next section.
</p>




<a name="the-java-volatile-happens-before-guarantee"></a>
<h2>The Java volatile Happens-Before Guarantee</h2>

<p>
    To address the instruction reordering challenge, the Java <code>volatile</code> keyword gives a
    "happens-before" guarantee, in addition to the visibility guarantee. The happens-before guarantee
    guarantees that:
</p>

<ul>
    <li>Reads from and writes to other variables cannot be reordered to occur after a write to a <code>volatile</code> variable,
        if the reads / writes originally occurred before the write to the <code>volatile</code> variable. <br>
        The reads / writes before a write to a <code>volatile</code> variable are guaranteed to "happen before"
        the write to the <code>volatile</code> variable.
        Notice that it is still possible for e.g. reads / writes of other variables located after a write to a <code>volatile</code>
        to be reordered to occur before that write to the <code>volatile</code>. Just not the other way around.
        From after to before is allowed, but from before to after is not allowed.
    </li>
</ul>
<ul>
    <li>
        Reads from and writes to other variables cannot be reordered to occur before a read of a <code>volatile</code>
        variable, if the reads / writes originally occurred after the read of the <code>volatile</code> variable.
        Notice that it is possible for reads of other variables that occur before the read of a <code>volatile</code>
        variable can be reordered to occur after the read of the <code>volatile</code>. Just not the other way around.
        From before to after is allowed, but from after to before is not allowed.
    </li>

</ul>

<p>
    The above happens-before guarantee assures that the visibility guarantee of the <code>volatile</code> keyword
    are being enforced.
</p>





<a name="volatile-is-not-always-enough"></a>
<h2>volatile is Not Always Enough</h2>

<p>
    Even if the <code>volatile</code> keyword guarantees that all reads of a <code>volatile</code> variable are
    read directly from main memory, and all writes to a <code>volatile</code> variable are written directly to
    main memory, there are still situations where it is not enough to declare a variable <code>volatile</code>.
</p>

<p>
    In the situation explained earlier where only Thread 1 writes to the shared <code>counter</code> variable,
    declaring the <code>counter</code> variable <code>volatile</code> is enough to make sure that Thread 2 always sees
    the latest written value.
</p>

<p>
    In fact, multiple threads could even be writing to a shared <code>volatile</code> variable, and still have the
    correct value stored in main memory, if the new value written to the variable does not depend on its previous value.
    In other words, if a thread writing a value to the shared <code>volatile</code> variable does not first need to
    read its value to figure out its next value.
</p>

<p>
    As soon as a thread needs to first read the value of a <code>volatile</code> variable, and based on that value
    generate a new value for the shared <code>volatile</code> variable, a <code>volatile</code> variable is no longer
    enough to guarantee correct visibility. The short time gap in between the reading of the <code>volatile</code>
    variable and the writing of its new value, creates an <a href="http://tutorials.jenkov.com/java-concurrency/race-conditions-and-critical-sections.html">race condition</a>
    where multiple threads might read the same value of the <code>volatile</code> variable, generate a new value
    for the variable, and when writing the value back to main memory - overwrite each other's values.
</p>

<p>
    The situation where multiple threads are incrementing the same counter is exactly such a situation where a
    <code>volatile</code> variable is not enough. The following sections explain this case in more detail.
</p>

<p>
    Imagine if Thread 1 reads a shared <code>counter</code> variable with the value 0 into its CPU cache, increment it to 1 and
    not write the changed value back into main memory. Thread 2 could then read the same <code>counter</code> variable
    from main memory where the value of the variable is still 0, into its own CPU cache. Thread 2 could then also increment
    the counter to 1, and also not write it back to main memory. This situation is illustrated in the diagram below:
</p>

<img src="./Java Volatile Keyword_files/java-volatile-3.png" alt="Two threads have read a shared counter variable into their local CPU caches and incremented it.">


<p>
    Thread 1 and Thread 2 are now practically out of sync. The real value of
    the shared <code>counter</code> variable should have been 2, but each of the threads has the value 1 for the variable
    in their CPU caches, and in main memory the value is still 0. It is a mess! Even if the threads eventually write their
    value for the shared <code>counter</code> variable back to main memory, the value will be wrong.
</p>




<a name="when-is-volatile-enough"></a>
<h2>When is volatile Enough?</h2>

<p>
    As I have mentioned earlier, if two threads are both reading and writing to a shared variable, then using the
    <code>volatile</code> keyword for that is not enough. You need to use a <a href="http://tutorials.jenkov.com/java-concurrency/synchronized.html">synchronized</a>
    in that case to guarantee that the reading and writing of the variable is atomic. Reading or writing a volatile
    variable does not block threads reading or writing. For this to happen you must use the <code>synchronized</code>
    keyword around critical sections.
</p>

<p>
    As an alternative to a <code>synchronized</code> block you could also use one of the many atomic data types
    found in the <a href="http://tutorials.jenkov.com/java-util-concurrent/index.html"><code>java.util.concurrent</code> package</a>. For instance,
    the <a href="http://tutorials.jenkov.com/java-util-concurrent/atomiclong.html"><code>AtomicLong</code></a> or
    <a href="http://tutorials.jenkov.com/java-util-concurrent/atomicreference.html"><code>AtomicReference</code></a> or one of the others.
</p>

<p>
    In case only one thread reads and writes the value of a volatile variable and other threads only read the variable,
    then the reading threads are guaranteed to see the latest value written to the volatile variable. Without making
    the variable volatile, this would not be guaranteed.
</p>

<p>
    The <code>volatile</code> keyword is guaranteed to work on 32 bit and 64 variables.
</p>




<a name="performance-considerations-of-volatile"></a>
<h2>Performance Considerations of volatile</h2>

<p>
    Reading and writing of volatile variables causes the variable to be read or written to main memory. Reading from
    and writing to main memory is more expensive than accessing the CPU cache. Accessing volatile variables also
    prevent instruction reordering which is a normal performance enhancement technique. Thus, you should only use volatile
    variables when you really need to enforce visibility of variables.
</p>
            </div>

            <div id="next">Next: <a href="http://tutorials.jenkov.com/java-concurrency/threadlocal.html">Java ThreadLocal</a></div>
            <div id="bottomSocial">

                <div style="display:inline-block;">
                    <table>
                        <tbody><tr><td colspan="2">
                            <div id="___plus_0" style="position: absolute; width: 450px; left: -10000px;"><iframe ng-non-bindable="" frameborder="0" hspace="0" marginheight="0" marginwidth="0" scrolling="no" style="position:absolute;top:-10000px;width:450px;margin:0px;border-style:none" tabindex="0" vspace="0" width="100%" id="I0_1580742889737" name="I0_1580742889737" src="./Java Volatile Keyword_files/sharebutton.html" data-gapiattached="true"></iframe></div><div class="g-plus" data-action="share" data-height="24" data-annotation="none" data-gapiscan="true" data-onload="true" data-gapistub="true"></div>
                            <script src="./Java Volatile Keyword_files/cb=gapi.loaded_1" async=""></script><script src="./Java Volatile Keyword_files/cb=gapi.loaded_0" async=""></script><script async="" src="./Java Volatile Keyword_files/analytics.js"></script><script id="twitter-wjs" src="./Java Volatile Keyword_files/widgets.js"></script><script type="text/javascript" async="" src="./Java Volatile Keyword_files/platform.js" gapi_processed="true"></script><script type="text/javascript">
                                (function() {
                                    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                                    po.src = 'https://apis.google.com/js/platform.js';
                                    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
                                 })();
                            </script>

                            <iframe id="twitter-widget-0" scrolling="no" frameborder="0" allowtransparency="true" allowfullscreen="true" class="twitter-share-button twitter-share-button-rendered twitter-tweet-button" style="position: static; visibility: visible; width: 61px; height: 20px;" title="Twitter Tweet Button" src="./Java Volatile Keyword_files/tweet_button.4f8aea4342a4ada72cba2bdffcff6b4d.en.html"></iframe>
                            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

                        </td></tr>
                        <tr><td class="authorPhoto"></td><td><p style="margin: 0px 0px 6px 0px;">Jakob Jenkov</p><div class="authorSocialLinks"></div></td></tr>
                    </tbody></table>
                </div>

                <div style="display: none;" class="newsletterForm"></div>

            </div>

        </div>
    </div><div class="right">
        <div class="card cardRight cardTop cardBottom">Right 1
            <div>Right 2</div>
        </div>
    </div>
    </div>
    <div class="footer">
        <div id="footerCopyright">Copyright Jenkov Aps</div>
    </div>
</div>

<style>
.navButton{color: #ffffff; font-weight: bold;}
#trailTocFixedDiv{position: fixed;  top : 0px; left : 0px; width : 100%; height : 100%;  display : none; background-color: #ffffff;}
#trailTocFixedInnerDiv{width: 400px; max-width: 94%; height: calc(100% - 72px); overflow : auto; margin: 20px auto 20px auto; padding: 0px 0px 180px 0px;}
#trailTocFixedInnerDiv th{border-bottom: 1px solid #f0f0f0;padding: 6px 10px;text-align: left;font-size: 1.2em;}
#trailTocFixedInnerDiv td{border-bottom: 1px solid #f0f0f0;padding: 6px 20px;vertical-align: top;}
#trailTocFixedCloseButton{width : 72px; padding: 10px 20px; background-color: #009900; border: 2px solid #006600; color: #ffffff; font-size: 0.8em; font-weight: bold; position: absolute; right: 0px; cursor: pointer; box-shadow: 2px 2px 2px 2px #cccccc;}
#bottomNavBarDiv{position:fixed; bottom: 0px; width: 100%;  background-color: #202020; border-top: 1px solid #444444;}
.buttonNavBarButtonDivActive{background-color: #404040;}
#bottomNavBarRow>div{border-left: 1px solid #404040; border-right: 1px solid #000000;  height: 48px;  padding-top:16px; text-align: center; cursor: pointer;}
#bottomNavBarDiv a{color: #ffffff; font-weight: bold;}
#bottomNavBarDiv br{display:none;}
#bottomNavBarDiv img{ height: 20px; }
#nextButton2{ display:none; }
@media only screen and (max-width: 700px){
  #bottomNavBarDiv, #bottomNavBarDiv [jqc-cell] { height: 58px; }
  #bottomNavBarDiv [jqc-cell] {padding-top: 12px;}
  #bottomNavBarDiv a { font-size: 0.8em; }
  #bottomNavBarDiv br { display: inline; }
  #nextButton1 { display: none; }
  #nextButton2 { display: inline; }
}
@media only screen and (max-width: 400px){
  #bottomNavBarDiv [jqc-cell] {padding-top: 10px;}
  #bottomNavBarDiv a {font-size: 0.5em;}
  #bottomNavBarDiv img {height: 24px;}
}
</style>


<div id="trailTocFixedDiv">
    <div id="trailTocFixedCloseButton">Close TOC</div>
    <div id="trailTocFixedInnerDiv"></div>
</div>

<style>
#bottomNavBar2Parent{position:fixed; bottom: 0px; width: 100%;  background-color: #202020; border-top: 1px solid #444444;}
#bottomNavBar2>div{border-left: 1px solid #404040; border-right: 1px solid #000000;  height: 48px;  padding-top:16px; text-align: center; cursor: pointer;}


#bottomNavBar2{
  display: grid;
}
#allTrailsButtonDiv2{
  grid-column-start: 1;
  grid-column-end: 3;
}

#trailTocButtonDiv2 {
  grid-column-start: 3;
  grid-column-end: 5;
}

#pageTocButtonDiv2{
  grid-column-start: 5;
  grid-column-end: 7;
}

#prevButtonDiv2 {
  grid-column-start: 7;
  grid-column-end: 9;
}

#nextButtonDiv2 {
  grid-column-start: 9;
  grid-column-end: 13;
}

</style>

<div id="bottomNavBar2Parent">
<div id="bottomNavBar2">

    <div id="allTrailsButtonDiv2">
        <span><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAbUlEQVRIx+3SQQrAIAxEUenNewrvmkXUQgVJEwWdQEED4kb+QzSEPw0z389yi6d3JJKaWY5ryBKgxSVS9jgF9OItQkRXRaBxDYHHJeISt34XND5EEHETQcY/iEfcvAkqbD7yAaYB1PkD7AB4TAY0StbUr69awQAAAABJRU5ErkJggg=="></span> <br>
        <span class="navButton" style="position:relative; top:-4px;">All Trails</span>
    </div>

    <div id="trailTocButtonDiv2">
        <span><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAPElEQVRIx2P4TwPAgAzoZgEDrQDdLaB6cI1aMHgtoFriGRkWEB3eg9YHo0E08BaM8CAiWoLaFlAL0NwCANELs4XjmhvVAAAAAElFTkSuQmCC"></span> <br>
        <span class="navButton" style="position:relative; top:-4px;">Trail TOC</span>
    </div>

    <div id="pageTocButtonDiv2">
        <span><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAANUlEQVRIx2NggIL/VAYM6GDUglELqGcBA4Vg1ALqWkBOhA4uH4wG0cBbMBpEw9QCagG6WQAAX980BcIgiscAAAAASUVORK5CYII="></span> <br>
        <span class="navButton" style="position:relative; top:-4px;">Page TOC</span>
    </div>

    <div id="prevButtonDiv2">
        <span><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuNvyMY98AAACCSURBVEhL3ZRRCsAgDEM9iez+dxJPUl0K9W+MtKMiC/RL80Lz0eKViNQxRpsvwnvHv8ssvGD8ORzjh7Odf4F34zxK30O1qImEV7Pw0nUJeEuFY/xwspZceKiWVLgqPUC1JQSAc0Iwh2+iZiIkdiqWdobknOslmM8JwcbxELaujSGl3GNH6mWcCMu2AAAAAElFTkSuQmCC"></span> <br>
        <span class="navButton" style="position:relative; top:-4px;">Previous</span>
    </div>

    <div id="nextButtonDiv2">
        <!--<span class="navButton" id="nextButton1_2" style="position:relative; top:-4px;">Next</span>-->
        <span><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAb0lEQVRIx82W2w1AIQhDmcS4/07GScDbu4AvUlMSv9QeA6RohnD3GhF9TAL7DeeK3cYuBEscgss6kBc16VlI2YTULKStIH9aMzXRgTxJlzaECpAQv+okaptSX35gFed+RBWn2jV14FBHJvVnwRT/AGJL6mWb6M7pAAAAAElFTkSuQmCC"></span> <br>
        <span class="navButton" id="nextButton2_2" style="position:relative; top:-4px;">Next</span>
    </div>

</div>
</div>


<script>
var prevArticleInCategory = "/java-concurrency/synchronized.html";
var nextArticleInCategory = "/java-concurrency/threadlocal.html";
</script>


<script>
function qid(id) { return document.getElementById(id); }
</script>

<!-- Nav bar code -->
<script>
function toggle(el){
    if(el.isShown == null || el.isShown == false) {
        el.isShown = true;
        el.style.display = "block";
    } else {
        el.isShown = false;
        el.style.display = "none";
    }
}

qid("allTrailsButtonDiv2").addEventListener("mouseup", function(e) {
    location.href="/";
    e.preventDefault();
    e.stopPropagation();
});
qid("trailTocButtonDiv2").addEventListener("mouseup", function(e) {
    var tocHtml = qid("trailToc").innerHTML;
    qid("trailTocFixedInnerDiv").innerHTML = tocHtml + "<br><br><br><br><br><br><br><br><br><br>";
    toggle(qid("trailTocFixedDiv"));
    e.preventDefault();
    e.stopPropagation();
});
qid("trailTocFixedCloseButton").addEventListener("mouseup", function(e) {
    toggle(qid("trailTocFixedDiv"));
    e.preventDefault();
    e.stopPropagation();
});
qid("pageTocButtonDiv2").addEventListener("mouseup", function(e) {
    location.href="#pageToc";
    e.preventDefault();
    e.stopPropagation();
});
qid("prevButtonDiv2").addEventListener("mouseup", function(e) {
    if(prevArticleInCategory != "") {
        location.href = prevArticleInCategory;
    } else {
        alert("This is the first article in this trail");
    }
});
qid("nextButtonDiv2").addEventListener("mouseup", function(e) {
  if(nextArticleInCategory != "") {
    location.href= nextArticleInCategory;
  } else {
    alert("This is the last article in this trail.");
  }
  e.preventDefault();
  e.stopPropagation();
});
</script>


<!-- Google Analytics Script -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-4036229-3', 'auto');
  ga('send', 'pageview');
</script>

<!-- Google Adsense Script -->
<script data-ad-client="ca-pub-5569543489255665" async="" src="./Java Volatile Keyword_files/f.txt"></script>





<iframe scrolling="no" frameborder="0" allowtransparency="true" src="./Java Volatile Keyword_files/widget_iframe.4f8aea4342a4ada72cba2bdffcff6b4d.html" title="Twitter settings iframe" style="display: none;"></iframe><iframe name="oauth2relay431892346" id="oauth2relay431892346" src="./Java Volatile Keyword_files/postmessageRelay.html" tabindex="-1" aria-hidden="true" style="width: 1px; height: 1px; position: absolute; top: -100px;"></iframe></body></html>