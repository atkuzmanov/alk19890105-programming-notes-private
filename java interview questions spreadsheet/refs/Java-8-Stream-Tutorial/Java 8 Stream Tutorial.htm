<!DOCTYPE html>
<!-- saved from url=(0069)https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    

    <meta name="author" content="Benjamin Winterberg">
    <meta name="description" content="Learn Java 8 streams by example: functional programming with filter, map, flatMap, reduce, collect, lambdas, sequential and parallel streams are covered in-depth in this tutorial.">
    <meta name="keywords" content="java, javascript, html, css, spring, hibernate, framework, computer, mobile, design, software, architecture, programming, development, engineering, code, pattern">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">

    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">

    <title>Java 8 Stream Tutorial</title>

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@winterbe_">
    <meta name="twitter:title" content="Java 8 Stream Tutorial">
    <meta name="twitter:description" content="Learn Java 8 streams by example: functional programming with filter, map, flatMap, reduce, collect, lambdas, sequential and parallel streams are covered in-depth in this tutorial.">
    <meta name="twitter:image:src" content="http://winterbe.com/image/twitter_card.jpg">

    <link rel="shortcut icon" href="https://winterbe.com/favicon.ico">
    <link rel="apple-touch-icon" href="https://winterbe.com/apple-touch-icon.png">

    <link rel="publisher" href="https://plus.google.com/105973259367211176218/">
    <link rel="author" href="https://plus.google.com/105973259367211176218/posts">

    <meta itemprop="name" content="Benjamin Winterberg">
    <meta itemprop="description" content="Learn Java 8 streams by example: functional programming with filter, map, flatMap, reduce, collect, lambdas, sequential and parallel streams are covered in-depth in this tutorial.">

    <link rel="alternate" type="application/rss+xml" title="Benjamin Winterberg" href="http://feeds.feedburner.com/winterbe">
    <link rel="alternate" type="application/atom+xml" title="Benjamin Winterberg" href="http://winterbe.com/atom.xml">

    <link rel="shortcut icon" type="image/x-icon" href="https://winterbe.com/favicon.ico">

    <link rel="apple-touch-icon" href="https://winterbe.com/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="57x57" href="https://winterbe.com/image/apple-touch-icon-57.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://winterbe.com/image/apple-touch-icon-72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://winterbe.com/image/apple-touch-icon-114.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://winterbe.com/image/apple-touch-icon-144.png">

    <link rel="stylesheet" href="./Java 8 Stream Tutorial_files/main.css">
    <link rel="stylesheet" href="./Java 8 Stream Tutorial_files/prism.css">

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script type="text/javascript" async="" src="./Java 8 Stream Tutorial_files/analytics.js"></script><script id="twitter-wjs" src="./Java 8 Stream Tutorial_files/widgets.js"></script><script async="" src="./Java 8 Stream Tutorial_files/js"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-48569937-1', {'anonymize_ip': true});
</script>

    <script type="text/javascript" id="cookiebanner" src="./Java 8 Stream Tutorial_files/cookiebanner.min.js" data-linkmsg="Privacy Policy" data-moreinfo="/privacy/"></script>
<script id="_carbonads_projs" type="text/javascript" src="./Java 8 Stream Tutorial_files/CKYI553Y.json"></script><script charset="utf-8" src="./Java 8 Stream Tutorial_files/button.a657e8de41cd5e7b38cde1f36c9ab9c2.js"></script></head>
<body>

<div class="container">
    <header>
        <a class="logo" href="https://winterbe.com/" title="winterbe.com">W</a>
<nav>
    <div id="nav-links" class="links">
        <span class="page-links">
            <a href="https://winterbe.com/blog/">Blog</a>
            <a href="https://winterbe.com/projects/">Projects</a>
            <a href="https://winterbe.com/vita/">Vita</a>
            <a href="https://winterbe.com/contact/">Contact</a>
        </span>
        <span class="social-links hide">
            <a href="http://feeds.feedburner.com/winterbe">RSS</a>
            <a href="https://github.com/winterbe">GitHub</a>
            <a href="https://plus.google.com/105973259367211176218/" rel="author">Google+</a>
            <a href="https://twitter.com/winterbe_">Twitter</a>
        </span>
        <a href="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/#" class="btn" data-toggle="follow">Follow</a>
    </div>
    <a class="menu-icon">â˜°</a>
</nav>

    </header>

    <div class="content">
        <h1 class="page-title">Java 8 Stream Tutorial</h1>

<p class="page-subtitle" data-page-url="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/">
    <span class="post-date">July 31, 2014</span><br>
    <span class="share-count-total"></span>
</p>

<div id="carbonads-container">
    <script async="" type="text/javascript" src="./Java 8 Stream Tutorial_files/carbon.js" id="_carbonads_js"></script><div id="carbonads"><span><span class="carbon-wrap"><a href="https://srv.carbonads.net/ads/click/x/GTND42QYCTAIKKQJFTY4YKQMFTYI4K3UCVYIPZ3JCWAD4K37CTYDK2QKC6BIEK37FTSDEK3EHJNCLSIZ?segment=placement:winterbecom;" class="carbon-img" target="_blank" rel="noopener sponsored"><img src="./Java 8 Stream Tutorial_files/1580325181-digitalocean-260x200-blue_1_.png" alt="ads via Carbon" border="0" style="max-width: 130px;"></a><a href="https://srv.carbonads.net/ads/click/x/GTND42QYCTAIKKQJFTY4YKQMFTYI4K3UCVYIPZ3JCWAD4K37CTYDK2QKC6BIEK37FTSDEK3EHJNCLSIZ?segment=placement:winterbecom;" class="carbon-text" target="_blank" rel="noopener sponsored">Try DigitalOcean today and get a free $100 credit</a></span><a href="http://carbonads.net/?utm_source=winterbecom&amp;utm_medium=ad_via_link&amp;utm_campaign=in_unit&amp;utm_term=carbon" class="carbon-poweredby" target="_blank" rel="noopener sponsored">ads via Carbon</a><img src="./Java 8 Stream Tutorial_files/B23029661.252757665" border="0" height="1" width="1" alt="ads via Carbon" style="display: none;"></span></div>
</div>

<div class="post">
    <p>This example-driven tutorial gives an in-depth overview about Java 8 streams. When I first read about the <code>Stream</code> API, I was confused about the name since it sounds similar to <code>InputStream</code> and <code>OutputStream</code> from Java I/O. But Java 8 streams are a completely different thing. Streams are <a href="http://en.wikipedia.org/wiki/Monad_%28functional_programming%29">Monads</a>, thus playing a big part in bringing <em>functional programming</em> to Java:</p>

<blockquote>
<p>In functional programming, a monad is a structure that represents computations defined as sequences of steps. A type with a monad structure defines what it means to chain operations, or nest functions of that type together.</p>
</blockquote>

<p>This guide teaches you how to work with Java 8 streams and how to use the different kind of available stream operations. You'll learn about the processing order and how the ordering of stream operations affect runtime performance. The more powerful stream operations <code>reduce</code>, <code>collect</code> and <code>flatMap</code> are covered in detail. The tutorial ends with an in-depth look at parallel streams.</p>

<p>If you're not yet familiar with Java 8 lambda expressions, functional interfaces and method references, you probably want to read my <a href="http://winterbe.com/posts/2014/03/16/java-8-tutorial/">Java 8 Tutorial</a> first before starting with this tutorial.</p>

<h3 id="how-streams-work">How streams work<a class="hash-link" href="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/#how-streams-work" title="Permalink to this section">#</a></h3>

<p>A stream represents a sequence of elements and supports different kind of operations to perform computations upon those elements:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">List<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> myList <span class="token operator">=</span>
    Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"a1"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"c2"</span><span class="token punctuation">,</span> <span class="token string">"c1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

myList
    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"c"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>String<span class="token operator">:</span><span class="token operator">:</span>toUpperCase<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// C1</span>
<span class="token comment">// C2</span>
</code></pre></figure>
<p>Stream operations are either intermediate or terminal. Intermediate operations return a stream so we can chain multiple intermediate operations without using semicolons. Terminal operations are either void or return a non-stream result. In the above example <code>filter</code>, <code>map</code> and <code>sorted</code> are intermediate operations whereas <code>forEach</code> is a terminal operation. For a full list of all available stream operations see the <a href="http://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html">Stream Javadoc</a>. Such a chain of stream operations as seen in the example above is also known as <em>operation pipeline</em>.</p>

<p>Most stream operations accept some kind of lambda expression parameter, a functional interface specifying the exact behavior of the operation. Most of those operations must be both <em>non-interfering</em> and <em>stateless</em>. What does that mean?</p>

<p>A function is <a href="http://docs.oracle.com/javase/8/docs/api/java/util/stream/package-summary.html#NonInterference">non-interfering</a> when it does not modify the underlying data source of the stream, e.g. in the above example no lambda expression does modify <code>myList</code> by adding or removing elements from the collection.</p>

<p>A function is <a href="http://docs.oracle.com/javase/8/docs/api/java/util/stream/package-summary.html#Statelessness">stateless</a> when the execution of the operation is deterministic, e.g. in the above example no lambda expression depends on any mutable variables or states from the outer scope which might change during execution.</p>

<h3 id="different-kind-of-streams">Different kind of streams<a class="hash-link" href="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/#different-kind-of-streams" title="Permalink to this section">#</a></h3>

<p>Streams can be created from various data sources, especially collections. Lists and Sets support new methods <code>stream()</code> and <code>parallelStream()</code> to either create a sequential or a parallel stream. Parallel streams are capable of operating on multiple threads and will be covered in a later section of this tutorial. We focus on sequential streams for now:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"a1"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"a3"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// a1</span>
</code></pre></figure>
<p>Calling the method <code>stream()</code> on a list of objects returns a regular object stream. But we don't have to create collections in order to work with streams as we see in the next code sample:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Stream<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"a1"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"a3"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// a1</span>
</code></pre></figure>
<p>Just use <code>Stream.of()</code> to create a stream from a bunch of object references.</p>

<p>Besides regular object streams Java 8 ships with special kinds of streams for working with the primitive data types <code>int</code>, <code>long</code> and <code>double</code>. As you might have guessed it's <code>IntStream</code>, <code>LongStream</code> and <code>DoubleStream</code>.</p>

<p>IntStreams can replace the regular for-loop utilizing <code>IntStream.range()</code>:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">IntStream<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1</span>
<span class="token comment">// 2</span>
<span class="token comment">// 3</span>
</code></pre></figure>
<p>All those primitive streams work just like regular object streams with the following differences: Primitive streams use specialized lambda expressions, e.g. <code>IntFunction</code> instead of <code>Function</code> or <code>IntPredicate</code> instead of <code>Predicate</code>. And primitive streams support the additional terminal aggregate operations <code>sum()</code> and <code>average()</code>:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Arrays<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>n <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">*</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">average</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 5.0</span>
</code></pre></figure>
<p>Sometimes it's useful to transform a regular object stream to a primitive stream or vice versa. For that purpose object streams support the special mapping operations <code>mapToInt()</code>, <code>mapToLong()</code> and <code>mapToDouble</code>:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Stream<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"a1"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"a3"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> s<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span>Integer<span class="token operator">:</span><span class="token operator">:</span>parseInt<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 3</span>
</code></pre></figure>
<p>Primitive streams can be transformed to object streams via <code>mapToObj()</code>:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">IntStream<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token string">"a"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// a1</span>
<span class="token comment">// a2</span>
<span class="token comment">// a3</span>
</code></pre></figure>
<p>Here's a combined example: the stream of doubles is first mapped to an int stream and than mapped to an object stream of strings:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Stream<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span>Double<span class="token operator">:</span><span class="token operator">:</span>intValue<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token string">"a"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// a1</span>
<span class="token comment">// a2</span>
<span class="token comment">// a3</span>
</code></pre></figure>
<h3 id="processing-order">Processing Order<a class="hash-link" href="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/#processing-order" title="Permalink to this section">#</a></h3>

<p>Now that we've learned how to create and work with different kinds of streams, let's dive deeper into how stream operations are processed under the hood.</p>

<p>An important characteristic of intermediate operations is laziness. Look at this sample where a terminal operation is missing:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Stream<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"filter: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></figure>
<p>When executing this code snippet, nothing is printed to the console. That is because intermediate operations will only be executed when a terminal operation is present.</p>

<p>Let's extend the above example by the terminal operation <code>forEach</code>:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Stream<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"filter: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"forEach: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></figure>
<p>Executing this code snippet results in the desired output on the console:</p>
<figure class="highlight"><pre class=" language-text"><code class=" language-text" data-lang="text">filter:  d2
forEach: d2
filter:  a2
forEach: a2
filter:  b1
forEach: b1
filter:  b3
forEach: b3
filter:  c
forEach: c
</code></pre></figure>
<p>The order of the result might be surprising. A naive approach would be to execute the operations horizontally one after another on all elements of the stream. But instead each element moves along the chain vertically. The first string "d2" passes <code>filter</code> then <code>forEach</code>, only then the second string "a2" is processed.</p>

<p>This behavior can reduce the actual number of operations performed on each element, as we see in the next example:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Stream<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"map: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"anyMatch: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// map:      d2</span>
<span class="token comment">// anyMatch: D2</span>
<span class="token comment">// map:      a2</span>
<span class="token comment">// anyMatch: A2</span>
</code></pre></figure>
<p>The operation <code>anyMatch</code> returns <code>true</code> as soon as the predicate applies to the given input element. This is true for the second element passed "A2". Due to the vertical execution of the stream chain, <code>map</code> has only to be executed twice in this case. So instead of mapping all elements of the stream, <code>map</code> will be called as few as possible.</p>

<h4 id="why-order-matters">Why order matters<a class="hash-link" href="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/#why-order-matters" title="Permalink to this section">#</a></h4>

<p>The next example consists of two intermediate operations <code>map</code> and <code>filter</code> and the terminal operation <code>forEach</code>. Let's once again inspect how those operations are being executed:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Stream<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"map: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"filter: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"forEach: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// map:     d2</span>
<span class="token comment">// filter:  D2</span>
<span class="token comment">// map:     a2</span>
<span class="token comment">// filter:  A2</span>
<span class="token comment">// forEach: A2</span>
<span class="token comment">// map:     b1</span>
<span class="token comment">// filter:  B1</span>
<span class="token comment">// map:     b3</span>
<span class="token comment">// filter:  B3</span>
<span class="token comment">// map:     c</span>
<span class="token comment">// filter:  C</span>
</code></pre></figure>
<p>As you might have guessed both <code>map</code> and <code>filter</code> are called five times for every string in the underlying collection whereas <code>forEach</code> is only called once.</p>

<p>We can greatly reduce the actual number of executions if we change the order of the operations, moving <code>filter</code> to the beginning of the chain:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Stream<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"filter: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"map: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"forEach: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// filter:  d2</span>
<span class="token comment">// filter:  a2</span>
<span class="token comment">// map:     a2</span>
<span class="token comment">// forEach: A2</span>
<span class="token comment">// filter:  b1</span>
<span class="token comment">// filter:  b3</span>
<span class="token comment">// filter:  c</span>
</code></pre></figure>
<p>Now, <code>map</code> is only called once so the operation pipeline performs much faster for larger numbers of input elements. Keep that in mind when composing complex method chains.</p>

<p>Let's extend the above example by an additional operation, <code>sorted</code>:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Stream<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sort: %s; %s\n"</span><span class="token punctuation">,</span> s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s1<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"filter: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"map: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"forEach: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></figure>
<p>Sorting is a special kind of intermediate operation. It's a so called <em>stateful operation</em> since in order to sort a collection of elements you have to maintain state during ordering.</p>

<p>Executing this example results in the following console output:</p>
<figure class="highlight"><pre class=" language-text"><code class=" language-text" data-lang="text">sort:    a2; d2
sort:    b1; a2
sort:    b1; d2
sort:    b1; a2
sort:    b3; b1
sort:    b3; d2
sort:    c; b3
sort:    c; d2
filter:  a2
map:     a2
forEach: A2
filter:  b1
filter:  b3
filter:  c
filter:  d2
</code></pre></figure>
<p>First, the sort operation is executed on the entire input collection. In other words <code>sorted</code> is executed horizontally. So in this case <code>sorted</code> is called eight times for multiple combinations on every element in the input collection.</p>

<p>Once again we can optimize the performance by reordering the chain:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Stream<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"filter: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sort: %s; %s\n"</span><span class="token punctuation">,</span> s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s1<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"map: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"forEach: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// filter:  d2</span>
<span class="token comment">// filter:  a2</span>
<span class="token comment">// filter:  b1</span>
<span class="token comment">// filter:  b3</span>
<span class="token comment">// filter:  c</span>
<span class="token comment">// map:     a2</span>
<span class="token comment">// forEach: A2</span>
</code></pre></figure>
<p>In this example <code>sorted</code> is never been called because <code>filter</code> reduces the input collection to just one element. So the performance is greatly increased for larger input collections.</p>

<h3 id="reusing-streams">Reusing Streams<a class="hash-link" href="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/#reusing-streams" title="Permalink to this section">#</a></h3>

<p>Java 8 streams cannot be reused. As soon as you call any terminal operation the stream is closed:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Stream<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span> stream <span class="token operator">=</span>
    Stream<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

stream<span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// ok</span>
stream<span class="token punctuation">.</span><span class="token function">noneMatch</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// exception</span>
</code></pre></figure>
<p>Calling <code>noneMatch</code> after <code>anyMatch</code> on the same stream results in the following exception:</p>
<figure class="highlight"><pre class=" language-text"><code class=" language-text" data-lang="text">java.lang.IllegalStateException: stream has already been operated upon or closed
    at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:229)
    at java.util.stream.ReferencePipeline.noneMatch(ReferencePipeline.java:459)
    at com.winterbe.java8.Streams5.test7(Streams5.java:38)
    at com.winterbe.java8.Streams5.main(Streams5.java:28)
</code></pre></figure>
<p>To overcome this limitation we have to to create a new stream chain for every terminal operation we want to execute, e.g. we could create a stream supplier to construct a new stream with all intermediate operations already set up:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Supplier<span class="token operator">&lt;</span>Stream<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> streamSupplier <span class="token operator">=</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Stream<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"d2"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"b3"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

streamSupplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// ok</span>
streamSupplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">noneMatch</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ok</span>
</code></pre></figure>
<p>Each call to <code>get()</code> constructs a new stream on which we are save to call the desired terminal operation.</p>

<h3 id="advanced-operations">Advanced Operations<a class="hash-link" href="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/#advanced-operations" title="Permalink to this section">#</a></h3>

<p>Streams support plenty of different operations. We've already learned about the most important operations like <code>filter</code> or <code>map</code>. I leave it up to you to discover all other available operations (see <a href="http://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html">Stream Javadoc</a>). Instead let's dive deeper into the more complex operations <code>collect</code>, <code>flatMap</code> and <code>reduce</code>.</p>

<p>Most code samples from this section use the following list of persons for demonstration purposes:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    String name<span class="token punctuation">;</span>
    <span class="token keyword">int</span> age<span class="token punctuation">;</span>

    <span class="token function">Person</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

List<span class="token generics function"><span class="token punctuation">&lt;</span>Person<span class="token punctuation">&gt;</span></span> persons <span class="token operator">=</span>
    Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Max"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Peter"</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Pamela"</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"David"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></figure>
<h4 id="collect">Collect<a class="hash-link" href="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/#collect" title="Permalink to this section">#</a></h4>

<p>Collect is an extremely useful terminal operation to transform the elements of the stream into a different kind of result, e.g. a <code>List</code>, <code>Set</code> or <code>Map</code>. Collect accepts a <code>Collector</code> which consists of four different operations: a <em>supplier</em>, an <em>accumulator</em>, a <em>combiner</em> and a <em>finisher</em>. This sounds super complicated at first, but the good part is Java 8 supports various built-in collectors via the <code>Collectors</code> class. So for the most common operations you don't have to implement a collector yourself.</p>

<p>Let's start with a very common usecase:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">List<span class="token generics function"><span class="token punctuation">&lt;</span>Person<span class="token punctuation">&gt;</span></span> filtered <span class="token operator">=</span>
    persons
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>p <span class="token operator">-</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"P"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>filtered<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// [Peter, Pamela]</span>
</code></pre></figure>
<p>As you can see it's very simple to construct a list from the elements of a stream. Need a set instead of list - just use <code>Collectors.toSet()</code>.</p>

<p>The next example groups all persons by age:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Map<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> List<span class="token generics function"><span class="token punctuation">&lt;</span>Person<span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> personsByAge <span class="token operator">=</span> persons
    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>p <span class="token operator">-</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

personsByAge
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>age<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"age %s: %s\n"</span><span class="token punctuation">,</span> age<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// age 18: [Max]</span>
<span class="token comment">// age 23: [Peter, Pamela]</span>
<span class="token comment">// age 12: [David]</span>
</code></pre></figure>
<p>Collectors are extremely versatile. You can also create aggregations on the elements of the stream, e.g. determining the average age of all persons:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Double averageAge <span class="token operator">=</span> persons
    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">averagingInt</span><span class="token punctuation">(</span>p <span class="token operator">-</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>averageAge<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 19.0</span>
</code></pre></figure>
<p>If you're interested in more comprehensive statistics, the summarizing collectors return a special built-in summary statistics object. So we can simply determine <em>min</em>, <em>max</em> and arithmetic <em>average</em> age of the persons as well as the <em>sum</em> and <em>count</em>.</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">IntSummaryStatistics ageSummary <span class="token operator">=</span>
    persons
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">summarizingInt</span><span class="token punctuation">(</span>p <span class="token operator">-</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ageSummary<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// IntSummaryStatistics{count=4, sum=76, min=12, average=19.000000, max=23}</span>
</code></pre></figure>
<p>The next example joins all persons into a single string:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">String phrase <span class="token operator">=</span> persons
    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>p <span class="token operator">-</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span>age <span class="token operator">&gt;=</span> <span class="token number">18</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>p <span class="token operator">-</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">" and "</span><span class="token punctuation">,</span> <span class="token string">"In Germany "</span><span class="token punctuation">,</span> <span class="token string">" are of legal age."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>phrase<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// In Germany Max and Peter and Pamela are of legal age.</span>
</code></pre></figure>
<p>The join collector accepts a delimiter as well as an optional prefix and suffix.</p>

<p>In order to transform the stream elements into a map, we have to specify how both the keys and the values should be mapped. Keep in mind that the mapped keys must be unique, otherwise an <code>IllegalStateException</code> is thrown. You can optionally pass a merge function as an additional parameter to bypass the exception:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Map<span class="token generics function"><span class="token punctuation">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> persons
    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>
        p <span class="token operator">-</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span>age<span class="token punctuation">,</span>
        p <span class="token operator">-</span><span class="token operator">&gt;</span> p<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>name1<span class="token punctuation">,</span> name2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> name1 <span class="token operator">+</span> <span class="token string">";"</span> <span class="token operator">+</span> name2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {18=Max, 23=Peter;Pamela, 12=David}</span>
</code></pre></figure>
<p>Now that we know some of the most powerful built-in collectors, let's try to build our own special collector. We want to transform all persons of the stream into a single string consisting of all names in upper letters separated by the <code>|</code> pipe character. In order to achieve this we create a new collector via <code>Collector.of()</code>. We have to pass the four ingredients of a collector: a <em>supplier</em>, an <em>accumulator</em>, a <em>combiner</em> and a <em>finisher</em>.</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Collector<span class="token generics function"><span class="token punctuation">&lt;</span>Person<span class="token punctuation">,</span> StringJoiner<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> personNameCollector <span class="token operator">=</span>
    Collector<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">StringJoiner</span><span class="token punctuation">(</span><span class="token string">" | "</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment">// supplier</span>
        <span class="token punctuation">(</span>j<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> j<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// accumulator</span>
        <span class="token punctuation">(</span>j1<span class="token punctuation">,</span> j2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> j1<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>j2<span class="token punctuation">)</span><span class="token punctuation">,</span>               <span class="token comment">// combiner</span>
        StringJoiner<span class="token operator">:</span><span class="token operator">:</span>toString<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// finisher</span>

String names <span class="token operator">=</span> persons
    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>personNameCollector<span class="token punctuation">)</span><span class="token punctuation">;</span>

System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// MAX | PETER | PAMELA | DAVID</span>
</code></pre></figure>
<p>Since strings in Java are immutable, we need a helper class like <code>StringJoiner</code> to let the collector construct our string. The supplier initially constructs such a StringJoiner with the appropriate delimiter. The accumulator is used to add each persons upper-cased name to the StringJoiner. The combiner knows how to merge two StringJoiners into one. In the last step the finisher constructs the desired String from the StringJoiner.</p>

<h4 id="flatmap">FlatMap<a class="hash-link" href="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/#flatmap" title="Permalink to this section">#</a></h4>

<p>We've already learned how to transform the objects of a stream into another type of objects by utilizing the <code>map</code> operation. Map is kinda limited because every object can only be mapped to exactly one other object. But what if we want to transform one object into multiple others or none at all? This is where <code>flatMap</code> comes to the rescue.</p>

<p>FlatMap transforms each element of the stream into a stream of other objects. So each object will be transformed into zero, one or multiple other objects backed by streams. The contents of those streams will then be placed into the returned stream of the <code>flatMap</code> operation.</p>

<p>Before we see <code>flatMap</code> in action we need an appropriate type hierarchy:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java"><span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span>
    String name<span class="token punctuation">;</span>
    List<span class="token generics function"><span class="token punctuation">&lt;</span>Bar<span class="token punctuation">&gt;</span></span> bars <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Foo</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token punctuation">{</span>
    String name<span class="token punctuation">;</span>

    <span class="token function">Bar</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></figure>
<p>Next, we utilize our knowledge about streams to instantiate a couple of objects:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">List<span class="token generics function"><span class="token punctuation">&lt;</span>Foo<span class="token punctuation">&gt;</span></span> foos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// create foos</span>
IntStream
    <span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-</span><span class="token operator">&gt;</span> foos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token string">"Foo"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// create bars</span>
foos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>f <span class="token operator">-</span><span class="token operator">&gt;</span>
    IntStream
        <span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-</span><span class="token operator">&gt;</span> f<span class="token punctuation">.</span>bars<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token string">"Bar"</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">" &lt;- "</span> <span class="token operator">+</span> f<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></figure>
<p>Now we have a list of three foos each consisting of three bars.</p>

<p>FlatMap accepts a function which has to return a stream of objects. So in order to resolve the bar objects of each foo, we just pass the appropriate function:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">foos<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>f <span class="token operator">-</span><span class="token operator">&gt;</span> f<span class="token punctuation">.</span>bars<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>b <span class="token operator">-</span><span class="token operator">&gt;</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Bar1 &lt;- Foo1</span>
<span class="token comment">// Bar2 &lt;- Foo1</span>
<span class="token comment">// Bar3 &lt;- Foo1</span>
<span class="token comment">// Bar1 &lt;- Foo2</span>
<span class="token comment">// Bar2 &lt;- Foo2</span>
<span class="token comment">// Bar3 &lt;- Foo2</span>
<span class="token comment">// Bar1 &lt;- Foo3</span>
<span class="token comment">// Bar2 &lt;- Foo3</span>
<span class="token comment">// Bar3 &lt;- Foo3</span>
</code></pre></figure>
<p>As you can see, we've successfully transformed the stream of three foo objects into a stream of nine bar objects.</p>

<p>Finally, the above code example can be simplified into a single pipeline of stream operations:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">IntStream<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token string">"Foo"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span>f <span class="token operator">-</span><span class="token operator">&gt;</span> IntStream<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">mapToObj</span><span class="token punctuation">(</span>i <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token string">"Bar"</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">" &lt;- "</span> f<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>bars<span class="token operator">:</span><span class="token operator">:</span>add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>f <span class="token operator">-</span><span class="token operator">&gt;</span> f<span class="token punctuation">.</span>bars<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>b <span class="token operator">-</span><span class="token operator">&gt;</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></figure>
<p>FlatMap is also available for the <code>Optional</code> class introduced in Java 8. Optionals <code>flatMap</code> operation returns an optional object of another type. So it can be utilized to prevent nasty <code>null</code> checks.</p>

<p>Think of a highly hierarchical structure like this:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java"><span class="token keyword">class</span> <span class="token class-name">Outer</span> <span class="token punctuation">{</span>
    Nested nested<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Nested</span> <span class="token punctuation">{</span>
    Inner inner<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Inner</span> <span class="token punctuation">{</span>
    String foo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></figure>
<p>In order to resolve the inner string <code>foo</code> of an outer instance you have to add multiple null checks to prevent possible NullPointerExceptions:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Outer outer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Outer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>outer <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> outer<span class="token punctuation">.</span>nested <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> outer<span class="token punctuation">.</span>nested<span class="token punctuation">.</span>inner <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>outer<span class="token punctuation">.</span>nested<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></figure>
<p>The same behavior can be obtained by utilizing optionals <code>flatMap</code> operation:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Optional<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Outer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>o <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>nested<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>n <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>i <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></figure>
<p>Each call to <code>flatMap</code> returns an <code>Optional</code> wrapping the desired object if present or <code>null</code> if absent.</p>

<h4 id="reduce">Reduce<a class="hash-link" href="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/#reduce" title="Permalink to this section">#</a></h4>

<p>The reduction operation combines all elements of the stream into a single result. Java 8 supports three different kind of <code>reduce</code> methods. The first one reduces a stream of elements to exactly one element of the stream. Let's see how we can use this method to determine the oldest person:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">persons
    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> p1<span class="token punctuation">.</span>age <span class="token operator">&gt;</span> p2<span class="token punctuation">.</span>age <span class="token operator">?</span> p1 <span class="token operator">:</span> p2<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// Pamela</span>
</code></pre></figure>
<p>The <code>reduce</code> method accepts a <code>BinaryOperator</code> accumulator function. That's actually a <code>BiFunction</code> where both operands share the same type, in that case <code>Person</code>. BiFunctions are like <code>Function</code> but accept two arguments. The example function compares both persons ages in order to return the person with the maximum age.</p>

<p>The second <code>reduce</code> method accepts both an identity value and a <code>BinaryOperator</code> accumulator. This method can be utilized to construct a new Person with the aggregated names and ages from all other persons in the stream:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Person result <span class="token operator">=</span>
    persons
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            p1<span class="token punctuation">.</span>age <span class="token operator">+=</span> p2<span class="token punctuation">.</span>age<span class="token punctuation">;</span>
            p1<span class="token punctuation">.</span>name <span class="token operator">+=</span> p2<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
            <span class="token keyword">return</span> p1<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"name=%s; age=%s"</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>name<span class="token punctuation">,</span> result<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// name=MaxPeterPamelaDavid; age=76</span>
</code></pre></figure>
<p>The third <code>reduce</code> method accepts three parameters: an identity value, a <code>BiFunction</code> accumulator and a combiner function of type <code>BinaryOperator</code>. Since the identity values type is not restricted to the <code>Person</code> type, we can utilize this reduction to determine the sum of ages from all persons:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Integer ageSum <span class="token operator">=</span> persons
    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>sum<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> sum <span class="token operator">+=</span> p<span class="token punctuation">.</span>age<span class="token punctuation">,</span> <span class="token punctuation">(</span>sum1<span class="token punctuation">,</span> sum2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> sum1 <span class="token operator">+</span> sum2<span class="token punctuation">)</span><span class="token punctuation">;</span>

System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ageSum<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 76</span>
</code></pre></figure>
<p>As you can see the result is <em>76</em>, but what's happening exactly under the hood? Let's extend the above code by some debug output:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Integer ageSum <span class="token operator">=</span> persons
    <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>sum<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"accumulator: sum=%s; person=%s\n"</span><span class="token punctuation">,</span> sum<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> sum <span class="token operator">+=</span> p<span class="token punctuation">.</span>age<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>sum1<span class="token punctuation">,</span> sum2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"combiner: sum1=%s; sum2=%s\n"</span><span class="token punctuation">,</span> sum1<span class="token punctuation">,</span> sum2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> sum1 <span class="token operator">+</span> sum2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// accumulator: sum=0; person=Max</span>
<span class="token comment">// accumulator: sum=18; person=Peter</span>
<span class="token comment">// accumulator: sum=41; person=Pamela</span>
<span class="token comment">// accumulator: sum=64; person=David</span>
</code></pre></figure>
<p>As you can see the accumulator function does all the work. It first get called with the initial identity value <em>0</em> and the first person <em>Max</em>. In the next three steps <code>sum</code> continually increases by the age of the last steps person up to a total age of <em>76</em>.</p>

<p>Wait wat? The combiner never gets called? Executing the same stream in parallel will lift the secret:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Integer ageSum <span class="token operator">=</span> persons
    <span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>sum<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"accumulator: sum=%s; person=%s\n"</span><span class="token punctuation">,</span> sum<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> sum <span class="token operator">+=</span> p<span class="token punctuation">.</span>age<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>sum1<span class="token punctuation">,</span> sum2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"combiner: sum1=%s; sum2=%s\n"</span><span class="token punctuation">,</span> sum1<span class="token punctuation">,</span> sum2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> sum1 <span class="token operator">+</span> sum2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// accumulator: sum=0; person=Pamela</span>
<span class="token comment">// accumulator: sum=0; person=David</span>
<span class="token comment">// accumulator: sum=0; person=Max</span>
<span class="token comment">// accumulator: sum=0; person=Peter</span>
<span class="token comment">// combiner: sum1=18; sum2=23</span>
<span class="token comment">// combiner: sum1=23; sum2=12</span>
<span class="token comment">// combiner: sum1=41; sum2=35</span>
</code></pre></figure>
<p>Executing this stream in parallel results in an entirely different execution behavior. Now the combiner is actually called. Since the accumulator is called in parallel, the combiner is needed to sum up the separate accumulated values.</p>

<p>Let's dive deeper into parallel streams in the next chapter.</p>

<h3 id="parallel-streams">Parallel Streams<a class="hash-link" href="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/#parallel-streams" title="Permalink to this section">#</a></h3>

<p>Streams can be executed in parallel to increase runtime performance on large amount of input elements. Parallel streams use a common <code>ForkJoinPool</code> available via the static <code>ForkJoinPool.commonPool()</code> method. The size of the underlying thread-pool uses up to five threads - depending on the amount of available physical CPU cores:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">ForkJoinPool commonPool <span class="token operator">=</span> ForkJoinPool<span class="token punctuation">.</span><span class="token function">commonPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>commonPool<span class="token punctuation">.</span><span class="token function">getParallelism</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 3</span>
</code></pre></figure>
<p>On my machine the common pool is initialized with a parallelism of 3 per default. This value can be decreased or increased by setting the following JVM parameter:</p>
<figure class="highlight"><pre class=" language-text"><code class=" language-text" data-lang="text">-Djava.util.concurrent.ForkJoinPool.common.parallelism=5
</code></pre></figure>
<p>Collections support the method <code>parallelStream()</code> to create a parallel stream of elements. Alternatively you can call the intermediate method <code>parallel()</code> on a given stream to convert a sequential stream to a parallel counterpart.</p>

<p>In order to understate the parallel execution behavior of a parallel stream the next example prints information about the current thread to <code>sout</code>:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"a1"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"c2"</span><span class="token punctuation">,</span> <span class="token string">"c1"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"filter: %s [%s]\n"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">,</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"map: %s [%s]\n"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">,</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"forEach: %s [%s]\n"</span><span class="token punctuation">,</span>
        s<span class="token punctuation">,</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></figure>
<p>By investigating the debug output we should get a better understanding which threads are actually used to execute the stream operations:</p>
<figure class="highlight"><pre class=" language-text"><code class=" language-text" data-lang="text">filter:  b1 [main]
filter:  a2 [ForkJoinPool.commonPool-worker-1]
map:     a2 [ForkJoinPool.commonPool-worker-1]
filter:  c2 [ForkJoinPool.commonPool-worker-3]
map:     c2 [ForkJoinPool.commonPool-worker-3]
filter:  c1 [ForkJoinPool.commonPool-worker-2]
map:     c1 [ForkJoinPool.commonPool-worker-2]
forEach: C2 [ForkJoinPool.commonPool-worker-3]
forEach: A2 [ForkJoinPool.commonPool-worker-1]
map:     b1 [main]
forEach: B1 [main]
filter:  a1 [ForkJoinPool.commonPool-worker-3]
map:     a1 [ForkJoinPool.commonPool-worker-3]
forEach: A1 [ForkJoinPool.commonPool-worker-3]
forEach: C1 [ForkJoinPool.commonPool-worker-2]
</code></pre></figure>
<p>As you can see the parallel stream utilizes all available threads from the common <code>ForkJoinPool</code> for executing the stream operations. The output may differ in consecutive runs because the behavior which particular thread is actually used is non-deterministic.</p>

<p>Let's extend the example by an additional stream operation, <code>sort</code>:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"a1"</span><span class="token punctuation">,</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> <span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"c2"</span><span class="token punctuation">,</span> <span class="token string">"c1"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"filter: %s [%s]\n"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">,</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"map: %s [%s]\n"</span><span class="token punctuation">,</span>
            s<span class="token punctuation">,</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"sort: %s &lt;&gt; %s [%s]\n"</span><span class="token punctuation">,</span>
            s1<span class="token punctuation">,</span> s2<span class="token punctuation">,</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> s1<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">&gt;</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"forEach: %s [%s]\n"</span><span class="token punctuation">,</span>
        s<span class="token punctuation">,</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></figure>
<p>The result may look strange at first:</p>
<figure class="highlight"><pre class=" language-text"><code class=" language-text" data-lang="text">filter:  c2 [ForkJoinPool.commonPool-worker-3]
filter:  c1 [ForkJoinPool.commonPool-worker-2]
map:     c1 [ForkJoinPool.commonPool-worker-2]
filter:  a2 [ForkJoinPool.commonPool-worker-1]
map:     a2 [ForkJoinPool.commonPool-worker-1]
filter:  b1 [main]
map:     b1 [main]
filter:  a1 [ForkJoinPool.commonPool-worker-2]
map:     a1 [ForkJoinPool.commonPool-worker-2]
map:     c2 [ForkJoinPool.commonPool-worker-3]
sort:    A2 &lt;&gt; A1 [main]
sort:    B1 &lt;&gt; A2 [main]
sort:    C2 &lt;&gt; B1 [main]
sort:    C1 &lt;&gt; C2 [main]
sort:    C1 &lt;&gt; B1 [main]
sort:    C1 &lt;&gt; C2 [main]
forEach: A1 [ForkJoinPool.commonPool-worker-1]
forEach: C2 [ForkJoinPool.commonPool-worker-3]
forEach: B1 [main]
forEach: A2 [ForkJoinPool.commonPool-worker-2]
forEach: C1 [ForkJoinPool.commonPool-worker-1]
</code></pre></figure>
<p>It seems that <code>sort</code> is executed sequentially on the main thread only. Actually, <code>sort</code> on a parallel stream uses the new Java 8 method <code>Arrays.parallelSort()</code> under the hood. As stated in <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Arrays.html#parallelSort-T:A-">Javadoc</a> this method decides on the length of the array if sorting will be performed sequentially or in parallel:</p>

<blockquote>
<p>If the length of the specified array is less than the minimum granularity, then it is sorted using the appropriate Arrays.sort method.</p>
</blockquote>

<p>Coming back to the <code>reduce</code> example from the last section. We already found out that the combiner function is only called in parallel but not in sequential streams. Let's see which threads are actually involved:</p>
<figure class="highlight"><pre class=" language-java"><code class=" language-java" data-lang="java">List<span class="token generics function"><span class="token punctuation">&lt;</span>Person<span class="token punctuation">&gt;</span></span> persons <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Max"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Peter"</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"Pamela"</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token string">"David"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

persons
    <span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>sum<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"accumulator: sum=%s; person=%s [%s]\n"</span><span class="token punctuation">,</span>
                sum<span class="token punctuation">,</span> p<span class="token punctuation">,</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> sum <span class="token operator">+=</span> p<span class="token punctuation">.</span>age<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>sum1<span class="token punctuation">,</span> sum2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"combiner: sum1=%s; sum2=%s [%s]\n"</span><span class="token punctuation">,</span>
                sum1<span class="token punctuation">,</span> sum2<span class="token punctuation">,</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> sum1 <span class="token operator">+</span> sum2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></figure>
<p>The console output reveals that both the <em>accumulator</em> and the <em>combiner</em> functions are executed in parallel on all available threads:</p>
<figure class="highlight"><pre class=" language-text"><code class=" language-text" data-lang="text">accumulator: sum=0; person=Pamela; [main]
accumulator: sum=0; person=Max;    [ForkJoinPool.commonPool-worker-3]
accumulator: sum=0; person=David;  [ForkJoinPool.commonPool-worker-2]
accumulator: sum=0; person=Peter;  [ForkJoinPool.commonPool-worker-1]
combiner:    sum1=18; sum2=23;     [ForkJoinPool.commonPool-worker-1]
combiner:    sum1=23; sum2=12;     [ForkJoinPool.commonPool-worker-2]
combiner:    sum1=41; sum2=35;     [ForkJoinPool.commonPool-worker-2]
</code></pre></figure>
<p>In summary, it can be stated that parallel streams can bring be a nice performance boost to streams with a large amount of input elements. But keep in mind that some parallel stream operations like <code>reduce</code> and <code>collect</code> need additional computations (combine operations) which isn't needed when executed sequentially.</p>

<p>Furthermore we've learned that all parallel stream operations share the same JVM-wide common <code>ForkJoinPool</code>. So you probably want to avoid implementing slow blocking stream operations since that could potentially slow down other parts of your application which rely heavily on parallel streams.</p>

<h3 id="thats-it">That's it<a class="hash-link" href="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/#thats-it" title="Permalink to this section">#</a></h3>

<p>My programming guide to Java 8 streams ends here. If you're interested in learning more about Java 8 streams, I recommend to you the <a href="http://docs.oracle.com/javase/8/docs/api/java/util/stream/package-summary.html#NonInterference">Stream Javadoc</a> package documentation. If you want to learn more about the underlying mechanisms, you probably want to read Martin Fowlers article about <a href="http://martinfowler.com/articles/collection-pipeline/">Collection Pipelines</a>.</p>

<p>If you're interested in JavaScript as well, you may want to have a look at <a href="https://github.com/winterbe/streamjs">Stream.js</a> - a JavaScript implementation of the Java 8 Streams API. You may also wanna read my <a href="https://winterbe.com/posts/2014/03/16/java-8-tutorial/">Java 8 Tutorial</a> and my <a href="https://winterbe.com/posts/2014/04/05/java8-nashorn-tutorial/">Java 8 Nashorn Tutorial</a>.</p>

<p>Hopefully this tutorial was helpful to you and you've enjoyed reading it. The full source code of the tutorial samples is <a href="https://github.com/winterbe/java8-tutorial">hosted on GitHub</a>. Feel free to <a href="https://github.com/winterbe/java8-tutorial/fork">fork the repository</a> or send me your feedback via <a href="https://twitter.com/winterbe_">Twitter</a>.</p>

<p>Happy coding!</p>

</div>

<div class="social-share">
    <span></span>
    <script async="" defer="" id="github-bjs" src="./Java 8 Stream Tutorial_files/buttons.js"></script>

    <iframe id="twitter-widget-0" scrolling="no" frameborder="0" allowtransparency="true" allowfullscreen="true" class="twitter-follow-button twitter-follow-button-rendered" style="position: static; visibility: visible; width: 126px; height: 20px;" title="Twitter Follow Button" src="./Java 8 Stream Tutorial_files/follow_button.7303c29a8108bca4ac5c9ef008ed8164.en.html" data-screen-name="winterbe_"></iframe>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

    <iframe id="twitter-widget-1" scrolling="no" frameborder="0" allowtransparency="true" allowfullscreen="true" class="twitter-share-button twitter-share-button-rendered twitter-tweet-button" style="position: static; visibility: visible; width: 61px; height: 20px;" title="Twitter Tweet Button" src="./Java 8 Stream Tutorial_files/tweet_button.7303c29a8108bca4ac5c9ef008ed8164.en.html"></iframe>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

<section class="author">
    <div class="avatar"></div>
    Benjamin is Software Engineer, Full Stack Developer at <a href="http://pondus.de/en/homepage/">Pondus</a>, an excited runner and table foosball player.
    Get in touch on <a href="https://twitter.com/winterbe_">Twitter</a> and <a href="https://github.com/winterbe">GitHub</a>.
</section>

<h3 class="center">Read More</h3>

<ul class="tabs center device-large">
    <li class="tab active">
        <a href="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/#">Recent</a>
    </li>
    <li class="tab">
        <a href="https://winterbe.com/blog/">All Posts</a>
    </li>
    <li class="tab">
        <a href="https://winterbe.com/java/">Java</a>
    </li>
    <li class="tab">
        <a href="https://winterbe.com/javascript/">JavaScript</a>
    </li>
    <li class="tab">
        <a href="https://winterbe.com/tutorials/">Tutorials</a>
    </li>
</ul>

<ul class="tabs center device-small">
    <li class="tab active">
        <a href="https://winterbe.com/posts/2014/07/31/java8-stream-tutorial-examples/#">Recent</a>
    </li>
    <li class="tab">
        <a href="https://winterbe.com/blog/">All Posts</a>
    </li>
    <li class="tab">
        <a href="https://winterbe.com/java/">Java</a>
    </li>
    <li class="tab">
        <a href="https://winterbe.com/tutorials/">Tutorials</a>
    </li>
</ul>

<ul class="blog-items read-more">
    
    
    <li class="blog-item center">
        <a href="https://winterbe.com/posts/2018/09/24/java-11-tutorial/">
            <h1>Java 11 Tutorial</h1>
        </a>
    </li>
    
    
    
    <li class="blog-item center">
        <a href="https://winterbe.com/posts/2018/08/29/migrate-maven-projects-to-java-11-jigsaw/">
            <h1>Migrate Maven Projects to Java 11</h1>
        </a>
    </li>
    
    
    
    <li class="blog-item center">
        <a href="https://winterbe.com/posts/2018/07/23/kotlin-sequence-tutorial/">
            <h1>Kotlin Sequence Tutorial</h1>
        </a>
    </li>
    
    
    
    <li class="blog-item center">
        <a href="https://winterbe.com/posts/2015/08/24/integrate-reactjs-into-jquery-webapps/">
            <h1>Integrating React.js into Existing jQuery Web Applications</h1>
        </a>
    </li>
    
    
    
    <li class="blog-item center">
        <a href="https://winterbe.com/posts/2015/05/22/java8-concurrency-tutorial-atomic-concurrent-map-examples/">
            <h1>Java 8 Concurrency Tutorial: Atomic Variables and ConcurrentMap</h1>
        </a>
    </li>
    
    
</ul>

    </div>

    <footer>
        Â© 2009-2018 Benjamin Winterberg Â· <a href="https://winterbe.com/privacy/">Privacy</a>
    </footer>
</div>

<script src="./Java 8 Stream Tutorial_files/jquery.min.js"></script>
<script src="./Java 8 Stream Tutorial_files/prism.js"></script>
<script src="./Java 8 Stream Tutorial_files/main.js"></script>



<iframe scrolling="no" frameborder="0" allowtransparency="true" src="./Java 8 Stream Tutorial_files/widget_iframe.7303c29a8108bca4ac5c9ef008ed8164.html" title="Twitter settings iframe" style="display: none;"></iframe><iframe id="rufous-sandbox" scrolling="no" frameborder="0" allowtransparency="true" allowfullscreen="true" style="position: absolute; visibility: hidden; display: none; width: 0px; height: 0px; padding: 0px; border: none;" title="Twitter analytics iframe" src="./Java 8 Stream Tutorial_files/saved_resource.html"></iframe></body></html>