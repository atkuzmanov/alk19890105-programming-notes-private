!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function t(e,t,r){return t&&s(e.prototype,t),r&&s(e,r),e}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function r(e,t){return(r=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function o(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function f(e,t,r){return(f="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=c(e)););return e}(e,t);if(n){var s=Object.getOwnPropertyDescriptor(n,t);return s.get?s.get.call(r):s.value}})(e,t,r||e)}!function(){var e=document.querySelector('meta[name="service"]'),t=document.querySelector('meta[name="renderingMode"]');if(null!==e&&null!==t&&"voyager-web"===e.getAttribute("content")){var s=t.getAttribute("data-mode"),o=!0;document.addEventListener("load",function e(t){var r=t.target;if(o&&"IMG"===r.tagName&&r.hasAttribute("data-elementtiming")){o=!1;var n=function(){void 0!==performance.mark&&performance.mark("FMP_".concat(s)),document.removeEventListener("load",e)};"BIGPIPE"===s?requestAnimationFrame(function(){requestAnimationFrame(n)}):requestAnimationFrame(n)}},!0)}}();var i=function(e,t,r,n){this.type=e,this.bubbles=t,this.cancelable=r,this.target=n};i.prototype={stopPropagation:function(){},preventDefault:function(){this.defaultPrevented=!0}};var u={100:"Continue",101:"Switching Protocols",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choice",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",422:"Unprocessable Entity",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported"};var l={"Accept-Charset":!0,"Accept-Encoding":!0,Connection:!0,"Content-Length":!0,Cookie:!0,Cookie2:!0,"Content-Transfer-Encoding":!0,Date:!0,Expect:!0,Host:!0,"Keep-Alive":!0,Referer:!0,TE:!0,Trailer:!0,"Transfer-Encoding":!0,Upgrade:!0,"User-Agent":!0,Via:!0};function d(r,n){n.addEventListener(r,function(e){var t=n["on"+r];t&&"function"==typeof t&&t.call(e.target,e)})}function e(){this._eventListeners={};for(var e=["loadstart","progress","load","abort","loadend"],t=e.length-1;0<=t;t--)d(e[t],this)}function h(){e.call(this),this.readyState=h.UNSENT,this.requestHeaders={},this.requestBody=null,this.status=0,this.statusText="",this.upload=new e}e.prototype={addEventListener:function(e,t){this._eventListeners[e]=this._eventListeners[e]||[],this._eventListeners[e].push(t)},removeEventListener:function(e,t){for(var r=this._eventListeners[e]||[],n=0,s=r.length;n<s;++n)if(r[n]==t)return r.splice(n,1)},dispatchEvent:function(e){for(var t=e.type,r=this._eventListeners[t]||[],n=0;n<r.length;n++)"function"==typeof r[n]?r[n].call(this,e):r[n].handleEvent(e);return!!e.defaultPrevented},_progress:function(e,t,r){var n=new i("progress");n.target=this,n.lengthComputable=e,n.loaded=t,n.total=r,this.dispatchEvent(n)}},h.prototype=new e;var p={UNSENT:h.UNSENT=0,OPENED:h.OPENED=1,HEADERS_RECEIVED:h.HEADERS_RECEIVED=2,LOADING:h.LOADING=3,DONE:h.DONE=4,async:!0,withCredentials:!1,open:function(e,t,r,n,s){this.method=e,this.url=t,this.async="boolean"!=typeof r||r,this.username=n,this.password=s,this.responseText=null,this.responseXML=null,this.requestHeaders={},this.sendFlag=!1,this._readyStateChange(h.OPENED)},setRequestHeader:function(e,t){if(v(this),l[e]||/^(Sec-|Proxy-)/.test(e))throw new Error('Refused to set unsafe header "'+e+'"');this.requestHeaders[e]?this.requestHeaders[e]+=","+t:this.requestHeaders[e]=t},send:function(e){if(v(this),!/^(get|head)$/i.test(this.method)){var t=!1;Object.keys(this.requestHeaders).forEach(function(e){"content-type"===e.toLowerCase()&&(t=!0)}),t||(e||"").toString().match("FormData")||(this.requestHeaders["Content-Type"]="text/plain;charset=UTF-8"),this.requestBody=e}this.errorFlag=!1,this.sendFlag=this.async,this._readyStateChange(h.OPENED),"function"==typeof this.onSend&&this.onSend(this),this.dispatchEvent(new i("loadstart",!1,!1,this))},abort:function(){this.aborted=!0,this.responseText=null,this.errorFlag=!0,this.requestHeaders={},this.readyState>h.UNSENT&&this.sendFlag&&(this._readyStateChange(h.DONE),this.sendFlag=!1),this.readyState=h.UNSENT,this.dispatchEvent(new i("abort",!1,!1,this)),"function"==typeof this.onerror&&this.onerror()},getResponseHeader:function(e){if(this.readyState<h.HEADERS_RECEIVED)return null;if(/^Set-Cookie2?$/i.test(e))return null;for(var t in e=e.toLowerCase(),this.responseHeaders)if(t.toLowerCase()==e)return this.responseHeaders[t];return null},getAllResponseHeaders:function(){if(this.readyState<h.HEADERS_RECEIVED)return"";var e="";for(var t in this.responseHeaders)this.responseHeaders.hasOwnProperty(t)&&!/^Set-Cookie2?$/i.test(t)&&(e+=t+": "+this.responseHeaders[t]+"\r\n");return e},overrideMimeType:function(e){"string"==typeof e&&(this.forceMimeType=e.toLowerCase())},_readyStateChange:function(e){this.readyState=e,"function"==typeof this.onreadystatechange&&this.onreadystatechange(new i("readystatechange")),this.dispatchEvent(new i("readystatechange")),this.readyState==h.DONE&&(this.dispatchEvent(new i("load",!1,!1,this)),this.dispatchEvent(new i("loadend",!1,!1,this)))},_setResponseHeaders:function(e){for(var t in this.responseHeaders={},e)e.hasOwnProperty(t)&&(this.responseHeaders[t]=e[t]);this.forceMimeType&&(this.responseHeaders["Content-Type"]=this.forceMimeType),this.async?this._readyStateChange(h.HEADERS_RECEIVED):this.readyState=h.HEADERS_RECEIVED},_setResponseBody:function(e){!function(e){if(e.readyState==h.DONE)throw new Error("Request done")}(this),function(e){if(e.async&&e.readyState!=h.HEADERS_RECEIVED)throw new Error("No headers received")}(this),function(e){if("string"!=typeof e){var t=new Error("Attempted to respond to fake XMLHttpRequest with "+e+", which is not a string.");throw t.name="InvalidBodyException",t}}(e);var t=this.chunkSize||10,r=0;for(this.responseText="";this.async&&this._readyStateChange(h.LOADING),this.responseText+=e.substring(r,r+t),(r+=t)<e.length;);var n,s,o=this.getResponseHeader("Content-Type");if(this.responseText&&(!o||/(text\/xml)|(application\/xml)|(\+xml)/.test(o)))try{this.responseXML=(n=this.responseText,"undefined"!=typeof DOMParser?s=(new DOMParser).parseFromString(n,"text/xml"):((s=new ActiveXObject("Microsoft.XMLDOM")).async="false",s.loadXML(n)),s)}catch(e){}this.async?this._readyStateChange(h.DONE):this.readyState=h.DONE},respond:function(e,t,r){this._setResponseHeaders(t||{}),this.status="number"==typeof e?e:200,this.statusText=u[this.status],this._setResponseBody(r||"")}};for(var y in p)h.prototype[y]=p[y];function v(e){if(e.readyState!==h.OPENED)throw new Error("INVALID_STATE_ERR");if(e.sendFlag)throw new Error("INVALID_STATE_ERR")}var m=Number.MAX_VALUE,g=function(e){function p(){var e,t,r;return n(this,p),t=this,(e=!(r=c(p).call(this))||"object"!=typeof r&&"function"!=typeof r?o(t):r).chunkSize=m,h.call(o(o(e))),e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&r(e,t)}(p,h),t(p,[{key:"open",value:function(){f(c(p.prototype),"open",this).apply(this,arguments),this.method=this.method&&this.method.toUpperCase()}},{key:"_createMarkerName",value:function(e){return"mark_bigpipe_".concat(e)}},{key:"_hasPerformanceApi",value:function(){return!!(window&&window.performance&&window.performance.mark&&window.performance.measure&&window.performance.getEntriesByName)}},{key:"fulfillPendingRequest",value:function(e){var t=_bpr.requestSupervisor.responseTable[e],r=t.responseData,n=t.status;if(this._hasPerformanceApi()){var s=this._createMarkerName(e),o="".concat(s,"_phase"),i="".concat(s,"_start"),a="".concat(s,"_end");0<window.performance.getEntriesByName(i).length?(window.performance.mark(a),window.performance.measure(o,i,a)):window.jet&&window.jet.error(new Error("start merker not found: ".concat(i)),["bpr","perf_measure"],!1)}this.respond(n,{"Content-Type":"application/json"},r)}},{key:"send",value:function(e){var t=this.url;if(this._hasPerformanceApi()){var r=this._createMarkerName(t);window.performance.mark("".concat(r,"_start"))}if(_bpr.isPresentInTable("response",t))this.fulfillPendingRequest(t),_bpr.deleteJqueryRequest(t);else{var n=this.method,s=this.upload,o=this.responseType,i=this.username,a=void 0===i?"":i,u=this.password,l=void 0===u?"":u,d={url:t,method:n,async:this.async,username:a,password:l,timeout:this.timeout,requestHeaders:this.requestHeaders,withCredentials:this.withCredentials,xhr:this,isJqueryRequest:!1,postData:"POST"===n||"PUT"===n?e:null,events:{onreadystatechange:this.onreadystatechange,onload:this.onload,onerror:this.onerror,onprogress:this.onprogress,onloadstart:this.onloadstart,onabort:this.onabort,onloadend:this.onloadend,ontimeout:this.ontimeout},uploadEvents:{onload:s.onload,onerror:s.onerror,onprogress:s.onprogress,onloadstart:s.onloadstart,onabort:s.onabort,onloadend:s.onloadend,ontimeout:s.ontimeout}};o&&(d.responseType=o);var h=_bpr.isPresentInTable("jQuery",t);if(h&&(d.isJqueryRequest=!0,d.jqueryOptions=h.slice(-1)[0]),_bpr.requestSupervisor.terminatorCalled||"GET"!==n||_bpr.isBlacklistedUrl(t))return _bpr.refireRequest(d),void _bpr.deleteJqueryRequest(t);_bpr.isPresentInTable("request",t)||(_bpr.requestSupervisor.requestTable[t]=[]),_bpr.requestSupervisor.requestTable[t].push(d),f(c(p.prototype),"send",this).call(this,e)}}}]),p}();function q(e,t){var r=document.querySelector('meta[name="'.concat(e,'"]'));return r&&r.getAttribute("content")||t}var E=null,w=q("bigpipeResponseTimeout",12e3),R=q("bigpipeBlacklistUrls",""),b=function(){function r(){if(n(this,r),E)throw new Error("There can be only one instance of RequestManager.");var e=setTimeout(this._handleResponseTimeout.bind(this),w),t=[];return""!==R&&(t=JSON.parse(R).map(function(e){return new RegExp(e)})),this.requestSupervisor={requestTable:{},responseTable:{},jqueryRequests:{},originalXHR:null,originalJqueryAjax:null,terminatorCalled:!1,pageRendered:!1,isInitialPageLoaded:!1,responseTimer:e,refiredRequestUrls:[],blacklistUrlsRegex:t,VERSION:1},this._injectFakeXHR(),(E=this)._setupRequestSupervisorEventListener(),E}return t(r,[{key:"_replaceNavFragment",value:function(e,t,r){var n=document.getElementById(r),s=document.getElementById(e),o=document.getElementById(t);for(s.removeChild(o);n.hasChildNodes();)s.appendChild(n.removeChild(n.firstChild))}},{key:"_setupRequestSupervisorEventListener",value:function(){var o="datalet-bpr-guid",i=o.length,a="terminatorlet",u="navlet-header",l="navlet-footer",d=this;document.addEventListener("load",function e(t){var r=t.target;if("IMG"===r.tagName){var n=r.getAttribute("class");if(1===(n=n?n.split(" "):[]).length&&n[0].substring(0,i)===o){var s=n[0];d.response(s)}1===n.length&&n[0]===a&&(d.done(),document.removeEventListener("load",e,!0)),1===n.length&&n[0]===u&&d._replaceNavFragment("nav-head-container","nav-header",u),1===n.length&&n[0]===l&&d._replaceNavFragment("nav-foot-container","nav-footer",l)}},!0)}},{key:"isBlacklistedUrl",value:function(t){return this.requestSupervisor.blacklistUrlsRegex.some(function(e){return e.test(t)},this)}},{key:"isPresentInTable",value:function(e,t){var r=null;if("request"===e)r=this.requestSupervisor.requestTable;else if("response"===e)r=this.requestSupervisor.responseTable;else{if("jQuery"!==e)throw new Error("Invalid table name.");r=this.requestSupervisor.jqueryRequests}return r[t]}},{key:"deleteJqueryRequest",value:function(e){this.isPresentInTable("jQuery",e)&&delete this.requestSupervisor.jqueryRequests[e]}},{key:"_deleteRequest",value:function(e){delete this.requestSupervisor.requestTable[e],this.deleteJqueryRequest(e)}},{key:"_handleResponseTimeout",value:function(){console.info("Terminator datalet is not seen within ".concat(w," ms."))}},{key:"_injectFakeXHR",value:function(){this.requestSupervisor.originalXHR=window.XMLHttpRequest,window.XMLHttpRequest=g}},{key:"response",value:function(e){var t=e;"object"!==a(e)&&(t=JSON.parse(this._getResponseData(e)));var r=t.request,n=t.status,s=this._getResponseData(t.body),o={url:r,status:n,responseData:s};this.requestSupervisor.responseTable[r]=o;var i=this.requestSupervisor.requestTable[r];i&&(i.forEach(function(e){e.xhr.fulfillPendingRequest(r)}),this._deleteRequest(r))}},{key:"_getResponseData",value:function(e){var t=document.getElementById(e),r={};return t&&(t.normalize(),r=t.firstChild.nodeValue),r}},{key:"done",value:function(){if(this.requestSupervisor.terminatorCalled)throw new Error("Terminator cannot be called multiple times.");this.requestSupervisor.terminatorCalled=!0,this._clearResponseTimer(),this._fullFillPendingRequests(),this._refirePendingRequests(),this.requestSupervisor.pageRendered&&this._reset()}},{key:"_fullFillPendingRequests",value:function(){var r=this,e=this.requestSupervisor.requestTable;Object.keys(e).forEach(function(t){if(r.isPresentInTable("response",t)){var e=r.requestSupervisor.requestTable[t];e&&(e.forEach(function(e){e.xhr.fulfillPendingRequest(t)}),r._deleteRequest(t))}})}},{key:"_refirePendingRequests",value:function(){var t=this;Object.keys(this.requestSupervisor.requestTable).forEach(function(e){t.requestSupervisor.requestTable[e].forEach(function(e){t.refireRequest(e)},t)},this)}},{key:"_copyXhrData",value:function(e,t){var r=t.responseType;e.status=t.status,e.headers=t.headers,e.response=t.response,e.responseURL=t.responseURL,"document"===r?e.responseXML=t.responseXML:""!==r&&"text"!==r||(e.responseText=t.responseText)}},{key:"refireRequest",value:function(e){var t=e.xhr,r=e.url,n=e.jqueryOptions,s=e.requestHeaders,o=e.timeout,i=e.events,a=e.responseType,u=e.withCredentials,l=window.XMLHttpRequest;if(window.XMLHttpRequest=this.requestSupervisor.originalXHR,e.isJqueryRequest){var d=n.originalPromise;this.requestSupervisor.originalJqueryAjax(n).then(function(e,t,r){d.resolve(e,t,r)},function(e,t,r){d.reject(e,t,r)})}else{var h=new XMLHttpRequest,p=t,c=this;for(var f in h.open(e.method,r,e.async,e.username,e.password),s)h.setRequestHeader(f,s[f]);o&&(h.timeout=o),a&&(h.responseType=a),"undefined"!=typeof credentials&&(h.withCredentials=u),Object.keys(i).forEach(function(e){"function"==typeof i[e]&&(h[e]=function(){!p||"onreadystatechange"!==e&&"onload"!==e||c._copyXhrData(p,h),i[e].call(h)})});var y=e.uploadEvents;Object.keys(y).forEach(function(e){"function"==typeof y[e]&&(h.upload[e]=function(){p&&"onload"===e&&c._copyXhrData(p,h),y[e].call(h)})}),e.postData?h.send(e.postData):h.send()}window.XMLHttpRequest=l}},{key:"_resetRequestSupervisor",value:function(){this.requestSupervisor.responseTable={},this.requestSupervisor.requestTable={},this.requestSupervisor.jqueryRequests={}}},{key:"rendered",value:function(){if(this.requestSupervisor.pageRendered)throw new Error("Initial page render cannot be called multiple times.");this.requestSupervisor.pageRendered=!0,this.requestSupervisor.terminatorCalled&&this._reset()}},{key:"_reset",value:function(){if(this.requestSupervisor.isInitialPageLoaded)throw new Error("Request manager cannot be reset multiple times.");this._resetRequestSupervisor(),this.requestSupervisor.isInitialPageLoaded=!0,window.XMLHttpRequest=this.requestSupervisor.originalXHR,"undefined"!=typeof jQuery&&(jQuery.ajax=this.requestSupervisor.originalJqueryAjax)}},{key:"_clearResponseTimer",value:function(){var e=this.requestSupervisor.responseTimer;e&&(clearTimeout(e),this.requestSupervisor.responseTimer=null)}}]),r}();window._bpr=new b,window._getRenderMode=function(){if(!window||"node"!==window.appEnvironment){var e=document.getElementsByName("renderingMode");if(1!==e.length)return;return e[0].getAttribute("data-mode")}},window._isBigPipeMode=function(){var e=window._getRenderMode();return-1<["BIGPIPE","SSRPIPE"].indexOf(e)}});
//# sourceMappingURL=bigpipe.min.js.map
