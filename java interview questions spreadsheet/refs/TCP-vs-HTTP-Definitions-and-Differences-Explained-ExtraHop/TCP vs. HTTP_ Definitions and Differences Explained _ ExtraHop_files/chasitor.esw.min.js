window.esw.defineFeature("Chasitor",function(A){var x=/get[A-Z][A-Za-z0-9_]*/;var m=[".soma.salesforce.com",".salesforceliveagent.com",".internal.salesforce.com",".eng.sfdc.net",".gus.salesforce.com",".salesforcescrt.com"];function q(){this.esw=A;this.liveAgentChasitor=undefined;this.events=undefined;this.chasitorSettings=undefined;this.prechatFormDetails=undefined;this.prechatEntities=undefined;this.chatWindowStateName=undefined;this.chatKey=undefined;this.isTabMaster=undefined;this.receiveIsTabMasterFunction=undefined;this.registerMessageHandlers();if(A.getSafariType()!=="mobile"){this.registerBroadcastHandlers();}A.loadFeatureScript("FileTransfer");window.addEventListener("unload",function(){if(this.__synchronous_decrement_tab){if(this.chasitorSettings&&this.chasitorSettings.deploymentId){this.decrementActiveChatSession(this.chasitorSettings.deploymentId);}}}.bind(this));}function c(W){var X="";if(W&&typeof W==="string"){return W;}else{if(W.type==="ChatWindowButton"){X+="Button Selections:";}else{if(W.type==="ChatWindowMenu"){X+="Menu Options:";}}if(W.items){W.items.forEach(function(Y){X+="\n\t"+Y.text;});}}return X;}q.prototype.sendBroadcastEventToSlaveTabs=function F(W,X){var Y=X||{};if(!Y.domain){Y.domain=this.domain;}if(!Y.chatKey){Y.chatKey=this.chatKey;}A.broadcastAPI.send(W,Y);};q.prototype.getChatKeyFromSessionStorage=function y(X){var W=JSON.parse(A.sessionAPI.getSessionData(X,["CHASITOR_SERIALIZED_KEY"]).CHASITOR_SERIALIZED_KEY);if(W&&W.chasitorData){return W.chasitorData.chatKey;}return undefined;};q.prototype.isChatKeyValid=function n(W){if(!W){A.log("Chat key was not defined on receiving broadcast event.");}return this.chatKey===W;};q.prototype.registerMessageHandlers=function t(){A.addMessageHandler("chasitor.load",this.loadChasitor.bind(this));A.addMessageHandler("chasitor.sendMessage",function(X,W){this.sendMessage(W);}.bind(this));A.addMessageHandler("chasitor.sendRichMessage",function(X,W){this.sendRichMessage(W);}.bind(this));A.addMessageHandler("chasitor.cancelChat",function(){this.cancelChat();}.bind(this));A.addMessageHandler("chasitor.endChat",function(){this.endChat();}.bind(this));A.addMessageHandler("chasitor.abortConnection",function(){this.abortConnection();}.bind(this));A.addMessageHandler("chasitor.sendSneakPeekOrTypingUpdate",function(X,W){this.sendSneakPeekOrTypingUpdate(W);}.bind(this));A.addMessageHandler("chasitor.saveChat",function(){this.saveChat();}.bind(this));A.addMessageHandler("chasitor.updateChatWindowState",function(X,W){this.updateChatWindowState(W);}.bind(this));A.addMessageHandler("chasitor.removeEventListeners",function(){this.removeEventListeners();}.bind(this));A.addMessageHandler("chasitor.stopChasitorIdleTimeout",function(){this.stopChasitorIdleTimeout();}.bind(this));A.addMessageHandler("chasitor.sendCustomEvent",function(X,W){this.sendCustomEvent(W);}.bind(this));A.addMessageHandler("chasitor.getCustomEvents",function(){this.getCustomEvents();}.bind(this));A.addMessageHandler("chasitor.addCustomEventListener",function(X,W){this.addCustomEventListener(W);}.bind(this));A.addMessageHandler("chasitor.decrementActiveChatSession",function(X,W){this.decrementActiveChatSession(X,W);}.bind(this));};q.prototype.registerBroadcastHandlers=function z(){A.broadcastAPI.on("incrementActiveChatSession",function(W){if(this.liveAgentChasitor&&this.isChatKeyValid(W.chatKey)){this.incrementActiveChatSession();}}.bind(this));A.broadcastAPI.on("decrementActiveChatSession",function(W){if(this.liveAgentChasitor&&this.isChatKeyValid(W.chatKey)){this.decrementActiveChatSession();}}.bind(this));A.broadcastAPI.on("liveAgentChasitorEvent",function(W){if(this.isChatKeyValid(W.chatKey)&&!this.isTabMaster){parent.postMessage({method:"liveagent.event",data:W},A.parentOrigin);}}.bind(this));A.broadcastAPI.on("gatherChasitorSessionData",function(W){if(this.liveAgentChasitor){this.gatherChasitorSessionData(W);}}.bind(this));A.broadcastAPI.on("sendMessage",function(W){if(this.liveAgentChasitor&&this.isChatKeyValid(W.chatKey)){this.sendMessage(W.message);}}.bind(this));A.broadcastAPI.on("sendRichMessage",function(W){if(this.liveAgentChasitor&&this.isChatKeyValid(W.chatKey)){this.sendRichMessage(W.message);}}.bind(this));A.broadcastAPI.on("serializeChat",function(W){if(this.liveAgentChasitor&&this.isChatKeyValid(W.chatKey)){this.serializeChat();}}.bind(this));A.broadcastAPI.on("cancelChat",function(W){if(this.isChatKeyValid(W.chatKey)){parent.postMessage({method:"liveagent.chatCanceledOnDifferentTab"},A.parentOrigin);if(this.liveAgentChasitor){this.cancelChat();}}}.bind(this));A.broadcastAPI.on("endChat",function(W){if(this.isChatKeyValid(W.chatKey)){parent.postMessage({method:"liveagent.chatCanceledOnDifferentTab"},A.parentOrigin);if(this.liveAgentChasitor){this.endChat();}}}.bind(this));A.broadcastAPI.on("abortConnection",function(W){if(this.liveAgentChasitor&&this.isChatKeyValid(W.chatKey)){this.abortConnection();}}.bind(this));A.broadcastAPI.on("sendCustomEvent",function(W){if(this.liveAgentChasitor&&this.isChatKeyValid(W.chatKey)){this.sendCustomEvent(W);}}.bind(this));A.broadcastAPI.on("addCustomEventListener",function(W){if(this.liveAgentChasitor&&this.isChatKeyValid(W.chatKey)){this.addCustomEventListener();}}.bind(this));A.broadcastAPI.on("sendSneakPeekOrTypingUpdate",function(W){if(this.liveAgentChasitor&&this.isChatKeyValid(W.chatKey)){this.sendSneakPeekOrTypingUpdate(W.message);}}.bind(this));A.broadcastAPI.on("saveChat",function(W){if(this.liveAgentChasitor&&this.isChatKeyValid(W.chatKey)){this.saveChat();}}.bind(this));A.broadcastAPI.on("removeEventListeners",function(W){if(this.liveAgentChasitor&&this.isChatKeyValid(W.chatKey)){this.removeEventListeners();}}.bind(this));A.broadcastAPI.on("stopChasitorIdleTimeout",function(W){if(this.liveAgentChasitor&&this.isChatKeyValid(W.chatKey)){this.stopChasitorIdleTimeout();}}.bind(this));A.broadcastAPI.on("getQueuePosition",function(W){if(this.liveAgentChasitor&&this.isChatKeyValid(W.chatKey)){this.getQueuePosition();}}.bind(this));A.broadcastAPI.on("getIsTabMaster",function(W){if(W.domain===this.domain&&W.deploymentId===this.chasitorSettings.deploymentId){A.broadcastAPI.send("receiveIsTabMaster",{isMaster:this.isTabMaster,domain:this.domain,deploymentId:this.chasitorSettings.deploymentId});}}.bind(this));A.broadcastAPI.on("receiveIsTabMaster",function(W){if(W.domain===this.domain&&W.deploymentId===this.chasitorSettings.deploymentId&&this.receiveIsTabMasterFunction&&typeof this.isTabMaster==="undefined"){this.receiveIsTabMasterFunction(W.isMaster);}}.bind(this));};q.prototype.setChasitorData=function s(X,W){this.domain=X;this.chasitorSettings=W.settingsObj;this.hasOnlyExtraPrechatInfo=W.hasOnlyExtraPrechatInfo;this.prechatFormDetails=W.prechatFormDetails;this.prechatEntities=W.prechatEntities;};q.prototype.createScriptElement=function E(){var W=document.createElement("script");W.id="chasitorScript";W.type="text/javascript";W.onload=function(){this.chasitorInit();}.bind(this);W.onerror=function(){throw new Error("Loading chasitor script from SCRT threw an error.");};W.src=this.chasitorSettings.chasitorSrc;document.getElementsByTagName("head")[0].appendChild(W);};q.prototype.serializeChat=function D(){var W;var X;if(this.liveAgentChasitor&&!this.liveAgentChasitor.isChatEnded()&&(this.liveAgentChasitor.isChatRequestSuccessful()||this.liveAgentChasitor.isChatEngaged())){W=this.liveAgentChasitor.serialize();X=JSON.parse(W);X.chasitorData.isChatEstablished=this.chatWindowStateName==="Chat";A.sessionAPI.setSessionData(this.domain,{CHASITOR_SERIALIZED_KEY:JSON.stringify(X)});}};q.prototype.handleLiveAgentChasitorEvent=function J(Y,Z){var W=Z;var X;var aa=["chasitorAgentChatEnded","chasitorAgentDisconnected","chasitorChasitorChatCanceled","chasitorChatRequestFailed","chasitorConnectionError","chatbotEndedChat","postChat"];if(aa.indexOf(Y)>=0){this.esw.sessionAPI.deleteSessionData(this.domain,["MASTER_DEPLOYMENT_ID"]);this.removeActiveChatSession(this.domain,this.chasitorSettings.deploymentId);}if(Y===this.liveAgentChasitor.Events.CHAT_REQUEST_SUCCESSFUL){this.chatKey=this.liveAgentChasitor.getChatKey();}if(typeof Z==="object"){W={};Object.getOwnPropertyNames(Z).forEach(function(ab){if(typeof Z[ab]==="function"&&x.test(ab)){W[ab]=Z[ab]();}else{W[ab]=Z[ab];}});}else{W=Z;}X={event:Y,params:W,chasitorData:this.gatherChasitorSessionData()};if(Y!=="chasitorChatRequestSuccessful"){this.sendBroadcastEventToSlaveTabs("liveAgentChasitorEvent",X);}parent.postMessage({method:"liveagent.event",data:X},A.parentOrigin);};q.prototype.registerEvents=function N(){if(this.events){Object.keys(this.events).forEach(function(W){var X=this.events[W];this.liveAgentChasitor.addEventListener(X,this.handleLiveAgentChasitorEvent.bind(this,X),"ESW_"+X);}.bind(this));}};q.prototype.passPrechatDataToLiveAgent=function C(){if(this.prechatFormDetails===undefined||!this.prechatFormDetails.length){return;}this.prechatFormDetails.forEach(function(Y){var Z=Y.value;var W=Y.transcriptFields;var X;if(typeof Z==="string"){Z=Y.value.trim();}X=this.liveAgentChasitor.addCustomDetail(Y.label,Z,Y.displayToAgent);if(W){W.forEach(X.addTranscriptField);}if(Y.name==="FirstName"){this.liveAgentChasitor.setName(Z);this.liveAgentChasitor.setLocalName(Z);}}.bind(this));this.liveAgentChasitor.addCustomDetail("eswLiveAgentDevName",this.chasitorSettings.eswLiveAgentDevName,false);this.liveAgentChasitor.addCustomDetail("hasOnlyExtraPrechatInfo",this.hasOnlyExtraPrechatInfo,false);this.prechatEntities.forEach(function(X){var W;this.liveAgentChasitor.addEntity(X.entityName,X.showOnCreate,X.linkToEntityName,X.linkToEntityField,X.saveToTranscript);W=X.entityFieldMaps;W.forEach(function(Y){this.liveAgentChasitor.addEntityFieldsMap(X.entityName,Y.fieldName,Y.label,Y.doFind,Y.isExactMatch,Y.doCreate);}.bind(this));}.bind(this));};q.prototype.passCustomDetailsToLiveAgent=function w(){if(this.chasitorSettings.hasOwnProperty("chatbotVersion")&&this.chasitorSettings.chatbotVersion){this.liveAgentChasitor.addCustomDetail("chatbotVersion",this.chasitorSettings.chatbotVersion,false);}};q.prototype.isNewChatSession=function O(){return !A.sessionAPI.getSessionData(this.domain,["CHASITOR_SERIALIZED_KEY"]).CHASITOR_SERIALIZED_KEY;};q.prototype.gatherChasitorSessionData=function B(X){var W={chasitorSettings:this.chasitorSettings,acceptTime:this.liveAgentChasitor.getAcceptTime(),requestTime:this.liveAgentChasitor.getRequestTime(),oref:this.liveAgentChasitor.getOref(),chatKey:this.liveAgentChasitor.getChatKey(),connectionSessionId:this.liveAgentChasitor.getConnectionSessionId(),details:this.liveAgentChasitor.getDetails(),name:this.liveAgentChasitor.getName(),chatMessages:this.getChatMessages(),isSneakPeekEnabled:this.liveAgentChasitor.isSneakPeekEnabled(),isAgentTyping:this.liveAgentChasitor.isAgentTyping(),isFileRequested:this.liveAgentChasitor.isFileRequested(),isChatEstablished:this.liveAgentChasitor.isChatEstablished(),isChatEngaged:this.liveAgentChasitor.isChatEngaged(),isChatEnded:this.liveAgentChasitor.isChatEnded(),isChatTransferredToQueue:this.liveAgentChasitor.isChatTransferredToQueue(),isChatRequestSuccessful:this.liveAgentChasitor.isChatRequestSuccessful(),queuePosition:this.liveAgentChasitor.getQueuePosition(),orgId:this.liveAgentChasitor.getOrgId(),language:this.liveAgentChasitor.getLanguage(),lastUrl:this.liveAgentChasitor.getLastUrl(),transcriptSaveEnabled:this.liveAgentChasitor.getTranscriptSaveEnabled()};if(X){W.isSnapinsSlaveTab=true;this.sendBroadcastEventToSlaveTabs("chasitorSessionDataRefreshed",W);}return W;};q.prototype.getChatMessages=function V(){var W=this.liveAgentChasitor.getChatMessages();var X=[];W.forEach(function(Y){var Z={};Object.getOwnPropertyNames(Y).forEach(function(aa){if(typeof Y[aa]==="function"&&x.test(aa)){Z[aa]=Y[aa]();}});X.push(Z);});return X;};q.prototype.initializeChasitor=function T(){var Y="snapins";var W=this.chasitorSettings.endpointURL;var Z=this.chasitorSettings.contentServerURL;var X=this.chasitorSettings.visitorInfo;this.liveAgentChasitor.resetChasitorState();this.liveAgentChasitor.setOrgId(this.chasitorSettings.orgId);this.liveAgentChasitor.setDeploymentId(this.chasitorSettings.deploymentId);this.liveAgentChasitor.setButtonId(this.chasitorSettings.buttonId);this.passPrechatDataToLiveAgent();this.passCustomDetailsToLiveAgent();this.liveAgentChasitor.setReceiveQueueUpdates(this.chasitorSettings.isQueuePositionEnabled||false);this.liveAgentChasitor.setVisitorInfo(X.visitCount,X.originalReferrer,X.pages);this.liveAgentChasitor.init(W,Z,this.chasitorSettings.fallbackRouting,false);this.liveAgentChasitor.startChat(Y);parent.postMessage({method:"liveagent.initialized",data:{chasitorEvents:this.events,chasitorSessionData:this.gatherChasitorSessionData()}},A.parentOrigin);};q.prototype.restoreSession=function H(){var X;var W=false;if(this.liveAgentChasitor){this.liveAgentChasitor.deserialize(A.sessionAPI.getSessionData(this.domain,["CHASITOR_SERIALIZED_KEY"]).CHASITOR_SERIALIZED_KEY);this.liveAgentChasitor.setReceiveQueueUpdates(this.chasitorSettings.isQueuePositionEnabled);this.liveAgentChasitor.init(this.chasitorSettings.endpointURL,this.chasitorSettings.contentServerURL,this.chasitorSettings.fallbackRouting,false);this.liveAgentChasitor.reinitializeSession();this.liveAgentChasitor.restoreChasitorIdleTimeout();this.chatKey=this.liveAgentChasitor.getChatKey();parent.postMessage({method:"liveagent.restored",data:{chasitorEvents:this.events,chasitorSessionData:this.gatherChasitorSessionData()}},A.parentOrigin);}else{X=JSON.parse(A.sessionAPI.getSessionData(this.domain,["CHASITOR_EVENTS"]).CHASITOR_EVENTS);this.chatKey=this.getChatKeyFromSessionStorage(this.domain);A.broadcastAPI.on("chasitorSessionDataRefreshed",function(Y){if(!W){parent.postMessage({method:"liveagent.restored",data:{chasitorEvents:X,chasitorSessionData:Y}},A.parentOrigin);W=true;}});A.broadcastAPI.send("gatherChasitorSessionData","slaveTabRestore");}};q.prototype.chasitorInit=function j(){this.liveAgentChasitor=window.liveagent.chasitor;Object.defineProperty(this,"events",{get:function(){return this.liveAgentChasitor.Events;}.bind(this)});A.sessionAPI.setSessionData(this.domain,{CHASITOR_EVENTS:JSON.stringify(this.liveAgentChasitor.Events)});this.registerEvents();this.liveAgentChasitor.onMutate=function(){this.serializeChat();}.bind(this);this.startChatSession();};q.prototype.startChatSession=function v(){if(this.isNewChatSession()){this.initializeChasitor();}else{this.restoreSession();}};q.prototype.sendMessage=function b(W){var X={};if(this.liveAgentChasitor){this.liveAgentChasitor.sendMessage(W);}else{if(!document.hidden){X.message=W;this.sendBroadcastEventToSlaveTabs("sendMessage",X);}}};q.prototype.sendRichMessage=function d(W){var X={};if(this.liveAgentChasitor){this.liveAgentChasitor.sendSnapInRichMessage(W);}else{if(!document.hidden){X.message=W;this.sendBroadcastEventToSlaveTabs("sendRichMessage",X);}}};q.prototype.cancelChat=function S(){if(this.liveAgentChasitor){this.liveAgentChasitor.cancelChat();this.esw.sessionAPI.deleteSessionData(this.domain,["CHASITOR_SERIALIZED_KEY","MASTER_DEPLOYMENT_ID"]);this.removeActiveChatSession(this.domain,this.chasitorSettings.deploymentId);}this.sendBroadcastEventToSlaveTabs("cancelChat");};q.prototype.endChat=function l(){if(this.liveAgentChasitor){try{this.liveAgentChasitor.endChat();this.esw.sessionAPI.deleteSessionData(this.domain,["CHASITOR_SERIALIZED_KEY","MASTER_DEPLOYMENT_ID"]);this.removeActiveChatSession(this.domain,this.chasitorSettings.deploymentId);}catch(W){console.error(W);}}this.sendBroadcastEventToSlaveTabs("endChat");};q.prototype.getQueuePosition=function P(){if(this.liveAgentChasitor&&this.chasitorSettings.isQueuePositionEnabled){return this.liveAgentChasitor.getQueuePosition();}else{this.sendBroadcastEventToSlaveTabs("getQueuePosition");}return undefined;};q.prototype.removeActiveChatSession=function k(Y,W){var X=JSON.parse(A.sessionAPI.getSessionData(Y,["ACTIVE_CHAT_SESSIONS"],true).ACTIVE_CHAT_SESSIONS||"{}");delete X[W];A.sessionAPI.setSessionData(Y,{ACTIVE_CHAT_SESSIONS:JSON.stringify(X)},true);this.updateMaster(false,0);};q.prototype.incrementActiveChatSession=function G(){var X=this.domain?JSON.parse(A.sessionAPI.getSessionData(this.domain,["ACTIVE_CHAT_SESSIONS"],true).ACTIVE_CHAT_SESSIONS||"{}"):"{}";var W=this.chasitorSettings.deploymentId;if(this.liveAgentChasitor){if(!X[W]){X[W]=0;}X[W]+=1;A.sessionAPI.setSessionData(this.domain,{ACTIVE_CHAT_SESSIONS:JSON.stringify(X)},true);A.log("tabsdebug: set activeChatSessions in sessionStorage to: "+X[W]);this.updateMaster(true,X[W]);}else{this.updateMaster(false,X[W]+1);this.sendBroadcastEventToSlaveTabs("incrementActiveChatSession");}};q.prototype.decrementActiveChatSession=function K(){var X=this.domain?JSON.parse(A.sessionAPI.getSessionData(this.domain,["ACTIVE_CHAT_SESSIONS"],true).ACTIVE_CHAT_SESSIONS||"{}"):"{}";var W=this.chasitorSettings?this.chasitorSettings.deploymentId:undefined;if(this.liveAgentChasitor){X=this.domain?JSON.parse(A.sessionAPI.getSessionData(this.domain,["ACTIVE_CHAT_SESSIONS"],true).ACTIVE_CHAT_SESSIONS||"{}"):"{}";if(X[W]){X[W]-=1;}else{A.log("Decrement active chat sessions : Local Storage item ACTIVE_CHAT_SESSIONS not found for deployment id :"+W);}A.sessionAPI.setSessionData(this.domain,{ACTIVE_CHAT_SESSIONS:JSON.stringify(X)},true);A.log("tabsdebug: set activeChatSessions in sessionStorage to: "+X);this.updateMaster(true,X[W]);}else{this.updateMaster(false,X[W]-1);this.sendBroadcastEventToSlaveTabs("decrementActiveChatSession");}};q.prototype.updateMaster=function i(X,W){var Y={};Y.isMaster=this.isTabMaster;Y.activeChatSessions=W;A.postMessage("session.updateMaster",Y);};q.prototype.loadChasitorSlaveTab=function g(){this.restoreSession();this.incrementActiveChatSession();};q.prototype.loadChasitorMasterTab=function r(aa,Z){var W=Z.settingsObj.deploymentId;var X=JSON.parse(A.sessionAPI.getSessionData(aa,["ACTIVE_CHAT_SESSIONS"],true).ACTIVE_CHAT_SESSIONS||"{}");var Y=document.getElementById("chasitorScript");if(Y){Y.parentNode.removeChild(Y);[].slice.apply(document.querySelectorAll("iframe")).forEach(function(ac){var ab=ac.getAttribute("src");if(ab&&ab.indexOf("cdm")!==-1){ac.parentNode.removeChild(ac);}});this.removeEventListeners();}this.verifyScriptHost(this.chasitorSettings.chasitorSrc);this.createScriptElement();A.sessionAPI.setSessionData(aa,{MASTER_DEPLOYMENT_ID:W});if(A.getSafariType()!=="mobile"){X[W]?X[W]+=1:X[W]=1;A.sessionAPI.setSessionData(aa,{ACTIVE_CHAT_SESSIONS:JSON.stringify(X)},true);}this.updateMaster(true,1);};q.prototype.loadChasitor=function M(aa,Z){var W=Z.settingsObj.deploymentId;var X=JSON.parse(A.sessionAPI.getSessionData(aa,["ACTIVE_CHAT_SESSIONS"],true).ACTIVE_CHAT_SESSIONS||"{}");var Y=X[W]||0;this.__synchronous_decrement_tab=Z.__synchronous_decrement_tab;this.setChasitorData(aa,Z);this.receiveIsTabMasterFunction=function(ab){if(ab){this.isTabMaster=false;this.loadChasitorSlaveTab();A.broadcastAPI.off("receiveIsTabMaster");}else{if(Y===1&&!ab){this.isTabMaster=true;this.loadChasitorMasterTab(aa,Z);A.broadcastAPI.off("receiveIsTabMaster");}else{Y-=1;}}}.bind(this);if(Y===0||A.isInternetExplorer()||A.isEdge()){this.isTabMaster=true;this.loadChasitorMasterTab(aa,Z);}else{A.broadcastAPI.send("getIsTabMaster",{domain:this.domain,deploymentId:W});}};q.prototype.verifyScriptHost=function p(X,Y){var W;if(window.URL&&typeof window.URL==="function"){W=new URL(X).hostname;}else{if(X.indexOf("//")>-1){W=X.split("/")[2];}else{W=X.split("/")[0];}W=W.split(":")[0];W=W.split("?")[0];}if(!this.isValidHostname(W)){throw new Error(Y||"Chasitor script served from invalid host! Chasitor script must come from one of the following domains: "+m.join(", "));}};q.prototype.isValidHostname=function a(W){return m.some(function(X){return W.indexOf(X,W.length-X.length)>0;});};q.prototype.sendSneakPeekOrTypingUpdate=function h(W){var X={};if(this.liveAgentChasitor){if(this.liveAgentChasitor.isSneakPeekEnabled()){this.liveAgentChasitor.sendSneakPeek(W);}else{this.liveAgentChasitor.sendTypingUpdate(W.length);}}else{X.message=W;this.sendBroadcastEventToSlaveTabs("sendSneakPeekOrTypingUpdate",X);}};q.prototype.saveChat=function e(){var Z="";var Y=[];var W=[];var X=[];if(this.liveAgentChasitor){if(/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream){this.liveAgentChasitor.getChatMessages().forEach(function(aa){var ab=aa.getContent();if(typeof ab!=="string"){ab=c(ab);}if(ab){Y.push(aa.getName());W.push(aa.getTimestamp());X.push(ab);}});Z=JSON.stringify({names:Y,timestamps:W,messages:X});A.postMessage("liveagent.saveChatIOSCallback",{chasitorData:this.gatherChasitorSessionData(),textLog:Z});}else{this.liveAgentChasitor.saveChat();}}else{if(!document.hidden){this.sendBroadcastEventToSlaveTabs("saveChat");}}};q.prototype.abortConnection=function U(){if(this.liveAgentChasitor){this.liveAgentChasitor.abortConnection();this.serializeChat();}else{this.sendBroadcastEventToSlaveTabs("abortConnection");}};q.prototype.serialize=function f(){this.liveAgentChasitor.serialize();};q.prototype.sendCustomEvent=function R(W){if(this.liveAgentChasitor){this.liveAgentChasitor.sendCustomEvent(W.type,W.data);}else{this.sendBroadcastEventToSlaveTabs("sendCustomEvent",W);}};q.prototype.getCustomEvents=function u(){var W=this.liveAgentChasitor.getCustomEvents();var X=W.map(function(Z){return{source:Z.getSource(),type:Z.getType(),data:Z.getData(),date:Z.getDate()};});var Y=JSON.stringify(X);parent.postMessage({method:"liveagent.getCustomEventsResult",data:{customEvents:Y}},A.parentOrigin);};q.prototype.addCustomEventListener=function o(W){var X=function(Y){parent.postMessage({method:"liveagent.customEventReceived",data:{type:Y.getType(),data:Y.getData()}},A.parentOrigin);};if(this.liveAgentChasitor){this.liveAgentChasitor.addCustomEventListener(W,X);}else{this.sendBroadcastEventToSlaveTabs("addCustomEventListener",W);}};q.prototype.removeEventListeners=function L(){if(this.liveAgentChasitor){window.liveagent.removeEventListeners();}else{this.sendBroadcastEventToSlaveTabs("removeEventListeners");}};q.prototype.updateChatWindowState=function Q(W){this.chatWindowStateName=W;if(this.liveAgentChasitor){this.serializeChat();}else{this.sendBroadcastEventToSlaveTabs("serializeChat");}};q.prototype.stopChasitorIdleTimeout=function I(){if(this.liveAgentChasitor){this.liveAgentChasitor.stopChasitorIdleTimeout();}else{this.sendBroadcastEventToSlaveTabs("stopChasitorIdleTimeout");}};A.chasitorAPI=new q();});