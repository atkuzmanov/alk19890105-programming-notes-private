(function(){var a=["broadcast","chasitor","filetransfer","session"];function e(){this.parentOrigin=undefined;this.messageHandlers={};this.featureScripts={};this.sessionLoaded=false;this.pendingMessages={};this.availableFeatures=["script"];window.location.search.replace(/([a-zA-Z0-9]+)=([\S]+)/g,function(l,m,n){if(m==="parent"){this.parentOrigin=n;}}.bind(this));if(!this.parentOrigin){console.error("No domain set!");return;}this.addEventListeners();this.loadFeatureScript("Session");this.loadFeatureScript("Broadcast");this.addMessageHandler("script.load",function(m,l){this.loadFeatureScript(l);}.bind(this));this.addMessageHandler("session.updateStorage",function(s,r){var q=500;var m=r.deploymentId;var p=JSON.parse(esw.sessionAPI.getSessionData(s,["ACTIVE_CHAT_SESSIONS"],true).ACTIVE_CHAT_SESSIONS||"{}");var o=false;var l=false;var n=(this.isInternetExplorer()||this.isEdge())&&history.length===1&&!r.isRefresh;if(esw.sessionAPI.getSessionData(s,["MASTER_DEPLOYMENT_ID"]).MASTER_DEPLOYMENT_ID===m){if(r.isSamePageNavigation&&!n){o=true;}else{esw.sessionAPI.deleteSessionData(s,["CHASITOR_SERIALIZED_KEY","MASTER_DEPLOYMENT_ID"]);}}esw.broadcastAPI.on("sessionStorageData",function(t){var u=JSON.parse(t.sessionStorage);if(!this.sessionLoaded&&t.domain===s){l=true;Object.getOwnPropertyNames(u).forEach(function(v){if(v.indexOf("MASTER_DEPLOYMENT_ID")===-1){sessionStorage.setItem(v,u[v]);}});this.sessionLoaded=true;parent.postMessage({method:"session.onLoad"},this.parentOrigin);}}.bind(this));esw.broadcastAPI.on("getSessionStorageData",function(t){if(t.domain===s){if(o||esw.sessionAPI.getSessionData(s,["MASTER_DEPLOYMENT_ID"]).MASTER_DEPLOYMENT_ID===t.deploymentId){esw.broadcastAPI.send("sessionStorageData",{sessionStorage:JSON.stringify(sessionStorage),domain:s});}}});if(p[r.deploymentId]&&!o){esw.broadcastAPI.send("getSessionStorageData",{deploymentId:r.deploymentId,domain:s});setTimeout(function(){if(!l){this.sessionLoaded=true;delete p[r.deploymentId];esw.sessionAPI.setSessionData(s,{ACTIVE_CHAT_SESSIONS:JSON.stringify(p)},true);parent.postMessage({method:"session.onLoad"},this.parentOrigin);}}.bind(this),q);}else{parent.postMessage({method:"session.onLoad"},this.parentOrigin);}}.bind(this));}e.prototype.isInternetExplorer=function(){return"ActiveXObject" in window;};e.prototype.isEdge=function(){if(window.navigator&&window.navigator.userAgent&&typeof window.navigator.userAgent==="string"){return window.navigator.userAgent.indexOf("Edge")>-1;}return false;};e.prototype.log=function f(l){if(window.devMode){console.log(l);}};e.prototype.getSafariType=function k(){var m=navigator.userAgent.toLowerCase();var l=!window.safari;var n="ontouchend" in document;if(m.indexOf("chrome")===-1&&m.indexOf("safari")!==-1){if(l&&n){return"mobile";}else{return"desktop";}}return"none";};e.prototype.addMessageHandler=function i(l,m){this.messageHandlers[l]=m;};e.prototype.addEventListeners=function b(){window.addEventListener("message",function(p){var q=p.data;var o;var l;var n;var m;if(q&&q.method){l=p.origin.indexOf("://")+3;n=p.origin.substring(l);n=n.split(":")[0];o=q.domain;if(o&&n.substr(-".force.com".length)===".force.com"){o=o.split("/")[0];}if(p.origin!==window.esw.parentOrigin.substr(0,p.origin.length)){console.log("Message origin must match parent origin!");return;}if(n!==o&&n.indexOf("."+o,n.length-o.length-1)===-1){console.log("storageDomain ("+q.domain+") must be a parent of message origin domain ("+n+")!");return;}m=q.method.split(".")[0].toLowerCase();if(this.availableFeatures.indexOf(m)===-1){if(!this.pendingMessages[m]){this.pendingMessages[m]=[];}this.pendingMessages[m].push(q);}else{this.handleMessage(q);}}}.bind(this),false);};e.prototype.handleMessage=function d(l){if(this.messageHandlers[l.method]){this.messageHandlers[l.method](l.domain,l.data);}else{console.log("Unregistered method "+l.method+" received in frame.");}};e.prototype.defineFeature=function c(l,m){this.featureScripts[l]=m;};e.prototype.loadFeatureScript=function h(m,o){var n=m.toLowerCase();var l;if(a.indexOf(n)>-1){l=document.createElement("script");l.type="text/javascript";l.src="frame/"+n+".esw"+(window.devMode?"":".min")+".js";l.onload=function(){this.featureScripts[m](this);if(o){o();}this.availableFeatures.push(n);this.processPendingMessages(n);}.bind(this);document.body.appendChild(l);}else{throw new Error('"'+m+'" is not a valid feature name.');}};e.prototype.postMessage=function g(m,l){parent.postMessage({method:m,data:l},this.parentOrigin);};e.prototype.processPendingMessages=function j(l){if(this.pendingMessages[l]){this.pendingMessages[l].forEach(function(m){this.handleMessage(m);}.bind(this));this.pendingMessages[l]=undefined;}};window.esw=new e();})();